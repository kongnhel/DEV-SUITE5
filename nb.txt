socket.on("study_assist", async (data) => {
  const { content } = data;
  try {
    console.log("ğŸ“š AI á€áŸ†á–á»á„ášáŸ€á”á…áŸ†á˜áŸášáŸ€á“á±áŸ’á™á”áŸ’á¢á¼á“...");
    
    const prompt = `
      You are a brilliant and helpful Khmer Study Companion. 
      Analyze this educational content: "${content}"

      Task:
      1. Provide a concise SUMMARY of the content in Khmer.
      2. Extract 3 KEY CONCEPTS that the user must remember.
      3. Generate 3 Multiple Choice Questions (MCQ) based on the content to test the user.

      Return ONLY raw JSON:
      {
        "summary": "áŸáŸá…á€áŸ’áŠá¸áŸá„áŸ’ááŸá”á˜áŸášáŸ€á“á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš",
        "key_concepts": ["á…áŸ†á“á»á…á‘á¸áŸ¡", "á…áŸ†á“á»á…á‘á¸áŸ¢", "á…áŸ†á“á»á…á‘á¸áŸ£"],
        "quiz": [
          {"question": "áŸáŸ†áá½ášá‘á¸áŸ¡", "options": ["A", "B", "C", "D"], "answer": "A"},
          ...
        ],
        "funny_motivation": "á–á¶á€áŸ’á™á›á¾á€á‘á¹á€á…á·ááŸ’áá”áŸ‚á”á€áŸ†á”áŸ’á›áŸ‚á„áŸ—á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš"
      }
    `;

    // á”áŸ’ášá¾á˜áŸ‰á¼áŠáŸ‚á› Gemini 2.5 Flash áŠáŸ‚á›á”áŸ’á¢á¼á“á”á¶á“á†áŸ‚á€áƒá¾á‰á–á¸á˜á»á“
    const result = await client.models.generateContent({
      model: "gemini-2.5-flash", 
      contents: [{ role: "user", parts: [{ text: prompt }] }],
    });

    const response = JSON.parse(result.text.replace(/```json|```/g, "").trim());
    socket.emit("study_result", response);
  } catch (error) {
    socket.emit("error_occured", "AI áœá·á›á˜á»áá“á¹á„á˜áŸášáŸ€á“á”á“áŸ’áá·á…á á¾á™! " + error.message);
  }
});