<%- include('partials/header') %>

<style>
  :root { --primary: <%= theme || '#a855f7' %>; }
  
  /* áŸáŸ’á‘á¸á›áŸá˜áŸ’ášá¶á”áŸ‹ášá”á¶ášá€á˜áŸ’á›á¶áŸ†á„ Password */
  .strength-bar { 
    height: 4px; 
    border-radius: 2px; 
    transition: all 0.4s ease; 
    width: 0%; 
  }
  
  .input-container { position: relative; }
  
  /* á”áŸŠá¼áá»á„á”á¾á€á—áŸ’á“áŸ‚á€ */
  .eye-icon { 
    position: absolute; 
    right: 20px; 
    top: 50%; 
    transform: translateY(-50%); 
    cursor: pointer; 
    opacity: 0.5; 
    transition: 0.3s; 
    font-size: 1.2rem;
  }
  .eye-icon:hover { opacity: 1; color: var(--primary); }
</style>

<main class="max-w-md mx-auto my-16 p-8 bg-slate-900/50 backdrop-blur-xl border border-white/5 rounded-[40px] shadow-2xl relative overflow-hidden">
  <div class="absolute -top-10 -left-10 w-32 h-32 bg-purple-500/10 blur-[80px] rounded-full"></div>

  <div class="text-center mb-10 relative z-10">
    <h2 class="text-4xl font-black text-white uppercase italic tracking-tighter">Secure Neural ID</h2>
    <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-2">Identity Shield Protocol V2.7</p>
  </div>

  <div class="space-y-5 relative z-10">
    <button onclick="signInWithGoogle()" id="googleBtn" class="w-full flex items-center justify-center gap-3 bg-white text-black py-4 rounded-2xl font-bold text-sm hover:bg-slate-200 transition-all active:scale-95 shadow-xl">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" />
      Continue with Google
    </button>

    <div class="flex items-center gap-4 py-2">
      <div class="h-px flex-1 bg-white/5"></div>
      <span class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Or Use Email</span>
      <div class="h-px flex-1 bg-white/5"></div>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Email Address</label>
        <input type="email" id="email" class="w-full bg-black/40 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-purple-500 text-white text-sm transition-all" placeholder="user@neural.link" />
      </div>

      <div>
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Password</label>
        <div class="input-container">
          <input type="password" id="password" oninput="checkStrength(this.value)" class="w-full bg-black/40 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-purple-500 text-white text-sm transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <span class="eye-icon" onclick="togglePass('password')">ğŸ‘ï¸</span>
        </div>
        
        <div class="mt-3 px-1">
          <div class="bg-white/5 w-full h-1 rounded-full overflow-hidden">
            <div id="meter" class="strength-bar"></div>
          </div>
          <div class="flex justify-between mt-1">
            <span id="strengthText" class="text-[8px] font-bold uppercase tracking-widest text-slate-600">Security Check</span>
            <span id="strengthPercent" class="text-[8px] font-mono text-slate-500">0%</span>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Confirm Password</label>
        <div class="input-container">
          <input type="password" id="confirmPassword" class="w-full bg-black/40 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-purple-500 text-white text-sm transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <span class="eye-icon" onclick="togglePass('confirmPassword')">ğŸ‘ï¸</span>
        </div>
      </div>
    </div>

    <button onclick="handleRegister()" id="regBtn" class="w-full bg-purple-600 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-purple-500 transition-all shadow-lg shadow-purple-500/20 active:scale-95">
      INITIALIZE NEURAL ID
    </button>

    <p class="text-center text-[10px] text-slate-500">
      á˜á¶á“á‚áá“á¸ášá½á…á á¾á™? 
      <a href="/login" class="text-purple-400 font-black hover:underline ml-1">á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á“áŸ…á‘á¸á“áŸáŸ‡</a>
    </p>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "<%= firebaseConfig.apiKey %>",
    authDomain: "<%= firebaseConfig.authDomain %>",
    projectId: "<%= firebaseConfig.projectId %>",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // áŸ¡. á˜á»áá„á¶áš "á”á¾á€á—áŸ’á“áŸ‚á€" á˜á¾á› Password
  window.togglePass = (id) => {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
  };

  // áŸ¢. á˜á»áá„á¶ášá†áŸ‚á€á€á˜áŸ’ášá·á Password (Strong Meter)
  window.checkStrength = (pass) => {
    const meter = document.getElementById('meter');
    const text = document.getElementById('strengthText');
    const percent = document.getElementById('strengthPercent');
    let strength = 0;

    if (pass.length >= 8) strength += 25;
    if (pass.match(/[A-Z]/)) strength += 25;
    if (pass.match(/[0-9]/)) strength += 25;
    if (pass.match(/[^A-Za-z0-9]/)) strength += 25;

    meter.style.width = strength + "%";
    percent.innerText = strength + "%";

    if (strength <= 25) {
      meter.style.backgroundColor = "#ef4444"; // á€áŸ’ášá á˜ (Weak)
      text.innerText = "Security: Weak";
      text.style.color = "#ef4444";
    } else if (strength <= 75) {
      meter.style.backgroundColor = "#f59e0b"; // á›á¿á„ (Medium)
      text.innerText = "Security: Moderate";
      text.style.color = "#f59e0b";
    } else {
      meter.style.backgroundColor = "#10b981"; // á”áŸƒáá„ (Strong)
      text.innerText = "Security: Neural Grade (Strong)";
      text.style.color = "#10b981";
    }
  };

  // áŸ£. á˜á»áá„á¶ášá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á‡á¶á˜á½á™ Google
  window.signInWithGoogle = async () => {
    const btn = document.getElementById("googleBtn");
    btn.disabled = true;
    btn.innerText = "SYNCING NEURAL...";
    try {
      const result = await signInWithPopup(auth, provider);
      await sendTokenToBackend(result.user);
    } catch (error) {
      btn.disabled = false;
      btn.innerText = "Continue with Google";
      Swal.fire({ icon: "error", title: "Auth Failed!", text: error.message, background: "#0f172a", color: "#fff" });
    }
  };

  // áŸ¤. á˜á»áá„á¶ášá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á‡á¶á˜á½á™ Email
  window.handleRegister = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const btn = document.getElementById("regBtn");

    if (!email || !password || !confirmPassword) {
      return Swal.fire({ icon: "warning", title: "Missing Data", text: "á”á„á”áŸ’ášá¼á¢á¾á™! áŸá¼á˜á”áŸ†á–áŸá‰á±áŸ’á™á‚áŸ’ášá”áŸ‹áœá¶á›áŸá·á“!", background: "#0f172a", color: "#fff" });
    }

    if (password !== confirmPassword) {
      return Swal.fire({ icon: "error", title: "Mismatch!", text: "Password á‘á¶áŸ†á„á–á¸ášá˜á·á“áŠá¼á…á‚áŸ’á“á¶á‘áŸá”á„á”áŸ’ášá¼!", background: "#0f172a", color: "#fff" });
    }

    if (password.length < 8) {
      return Swal.fire({ icon: "warning", title: "Weak Key", text: "Password ááŸ’ášá¼áœá˜á¶á“á™áŸ‰á¶á„áá·á… áŸ¨ ááŸ’á‘á„áŸ‹á¡á¾á„á‘áŸ…!", background: "#0f172a", color: "#fff" });
    }

    btn.disabled = true;
    btn.innerText = "INITIALIZING...";

    try {
      const result = await createUserWithEmailAndPassword(auth, email, password);
      await sendTokenToBackend(result.user);
    } catch (error) {
      btn.disabled = false;
      btn.innerText = "INITIALIZE NEURAL ID";
      Swal.fire({ icon: "error", title: "Registration Failed!", text: error.message, background: "#0f172a", color: "#fff" });
    }
  };

async function sendTokenToBackend(user) {
    const idToken = await user.getIdToken();
    const res = await fetch("/api/auth/session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            idToken: idToken, 
            isRegistering: true // á”á“áŸ’ááŸ‚á˜á…áŸ†áá»á…á“áŸáŸ‡ áŠá¾á˜áŸ’á”á¸á”áŸ’ášá¶á”áŸ‹ Server áá¶á”á„á€áŸ†á–á»á„á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡
        }),
    });
    if (res.ok) {
      window.location.href = "/dashboard";
    } else {
      const errData = await res.json();
      Swal.fire({ icon: "error", title: "Session Failed", text: errData.message, background: "#0f172a", color: "#fff" });
    }
  }
</script>