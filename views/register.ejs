<%- include('partials/header') %>

<style>
  :root {
    --primary: <%= theme || "#a855f7" %>;
    --secondary: #6366f1;
    --bg-dark: #020617;
    --magic-glow: rgba(168, 85, 247, 0.3);
  }
  body {
    font-family: "Kantumruy Pro", sans-serif;
    background-color: var(--bg-dark);
    color: #f3f4f6;
    overflow-x: hidden;
  }

  /* áŸ¡. Interactive Magic Background */
  #neural-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -20;
    opacity: 0.25;
  }

  /* áŸ¢. Magic Card Architecture */
  .magic-card {
    position: relative;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(30px);
    border-radius: 40px;
    z-index: 1;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  .magic-card::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      transparent,
      var(--primary),
      transparent 30%
    );
    animation: rotateMagic 6s linear infinite;
    z-index: -1;
    opacity: 0.2;
  }
  @keyframes rotateMagic {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* áŸ£. Shimmer & UI Glow */
  .shimmer-text {
    background: linear-gradient(
      90deg,
      #fff,
      var(--primary),
      var(--secondary),
      #fff
    );
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 5s linear infinite;
  }
  @keyframes shine {
    to {
      background-position: 200% center;
    }
  }

  .input-magic {
    background: rgba(0, 0, 0, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    transition: all 0.4s ease;
  }
  .input-magic:focus {
    border-color: var(--primary) !important;
    box-shadow: 0 0 20px var(--magic-glow);
  }

  .btn-magic-auth {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff;
    font-weight: 900;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 20px var(--magic-glow);
  }
  .btn-magic-auth:hover {
    transform: scale(1.02);
    box-shadow: 0 0 35px var(--primary);
  }

  /* áŸ¤. Strength Bar Cyber Style */
  .strength-bar {
    height: 4px;
    border-radius: 2px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 0%;
  }

  /* áŸ¥. Responsive Grid */
  .auth-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 4rem;
    align-items: center;
  }
  @media (min-width: 1024px) {
    .auth-grid {
      grid-template-columns: 1.1fr 0.9fr;
    }
  }

  .float-ui {
    animation: float 4s ease-in-out infinite;
  }
  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }
</style>

<canvas id="neural-bg"></canvas>

<main class="max-w-7xl mx-auto my-12 p-6 md:p-12 relative">
  <div class="auth-grid">
    <section
      class="space-y-10 animate-in fade-in slide-in-from-left-10 duration-1000"
    >
      <div
        class="inline-flex items-center gap-3 px-6 py-2 rounded-full bg-purple-500/10 border border-purple-500/20 float-ui"
      >
        <span class="w-2 h-2 rounded-full bg-purple-500 animate-ping"></span>
        <span
          class="text-purple-400 text-xs font-black tracking-widest uppercase"
          >Start Your Neural Journey</span
        >
      </div>

      <h2
        class="text-5xl md:text-8xl font-black tracking-tighter shimmer-text italic uppercase leading-tight"
      >
        BECOME THE <br />
        FUTURE
      </h2>

      <div class="space-y-6 max-w-2xl">
        <p class="text-2xl md:text-3xl font-light text-white leading-tight">
          "á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á”á„áŸ’á€á¾á
          <span class="text-purple-400 font-bold">Identity</span> á¥á¡á¼áœá“áŸáŸ‡
          áŠá¾á˜áŸ’á”á¸á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á˜á“áŸ’áá¢á¶á‚á˜ AI á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“á”áŸ’á¢á¼á“!"
        </p>
        <p class="text-lg text-slate-400 italic leading-relaxed">
          áá¾á”áŸ’á¢á¼á“á…á„áŸ‹á”á¶á“á‡áŸ†á“á½á™á€á¶áš AI áŠáŸ‚á›áŸáŸ’á‚á¶á›áŸ‹á”áŸ’á¢á¼á“á…áŸ’á”á¶áŸáŸ‹á˜áŸ‚á“á‘áŸ?
          á€á¶ášá”á„áŸ’á€á¾áá‚áá“á¸á“á¹á„á‡á½á™á±áŸ’á™á”áŸ’ášá–áŸá“áŸ’á’ **Neural Network** ášá€áŸ’áŸá¶á‘á»á€ášá¶á›áŸ‹á€á¶ášá‡á‡áŸ‚á€
          á¯á€áŸá¶ášáŠáŸ‚á›á”á¶á“áŸáŸ’á€áŸá“ á“á·á„á€á¼áŠáŠáŸ‚á›á”á¶á“ Review á€áŸ’á“á»á„ **Secure Archive**
          á‡á¶ášáŸ€á„ášá á¼á!
        </p>
      </div>

      <div class="grid grid-cols-2 gap-6">
        <div class="flex items-center gap-4 text-slate-300">
          <span class="text-2xl">ğŸ§¬</span>
          <div class="flex flex-col">
            <span class="text-[10px] font-black uppercase">Personal Memory</span
            ><span class="text-[8px] text-slate-500 italic"
              >AI á…á„á…á¶áŸ†ášá¶á›áŸ‹á˜áŸášáŸ€á“á”áŸ’á¢á¼á“</span
            >
          </div>
        </div>
        <div class="flex items-center gap-4 text-slate-300">
          <span class="text-2xl">âš¡</span>
          <div class="flex flex-col">
            <span class="text-[10px] font-black uppercase">Priority Lane</span
            ><span class="text-[8px] text-slate-500 italic"
              >á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ Model á‡áŸ†á“á¶á“áŸ‹á…á»á„á€áŸ’ášáŸ„á™</span
            >
          </div>
        </div>
      </div>
    </section>

    <section class="animate-in fade-in slide-in-from-right-10 duration-1000">
      <div class="magic-card p-10 md:p-14">
        <div class="text-center mb-10">
          <h3
            class="text-3xl font-black text-white uppercase italic tracking-tighter"
          >
            New Identity
          </h3>
          <p class="text-[9px] text-slate-500 uppercase tracking-[0.4em] mt-3">
            Neural Initialization Protocol
          </p>
        </div>

        <div class="space-y-6">
          <button
            onclick="signInWithGoogle()"
            id="googleBtn"
            class="w-full flex items-center justify-center gap-3 bg-white text-black py-4 rounded-2xl font-bold text-[10px] hover:bg-slate-200 transition-all active:scale-95"
          >
            <img
              src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
              class="w-5 h-5"
            />
            SYNC WITH GOOGLE CLOUD
          </button>

          <div class="flex items-center gap-4 py-2">
            <div class="h-px flex-1 bg-white/5"></div>
            <span
              class="text-[8px] text-slate-600 uppercase font-black tracking-widest"
              >Or Secure Email Link</span
            >
            <div class="h-px flex-1 bg-white/5"></div>
          </div>

          <div class="space-y-5">
            <div>
              <label
                class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 ml-1"
                >Email Connection</label
              >
              <input
                type="email"
                id="email"
                class="input-magic w-full rounded-2xl px-6 py-5 outline-none text-white text-sm"
                placeholder="user@neural.link"
              />
            </div>

            <div>
              <label
                class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 ml-1"
                >Encryption Key (Password)</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  oninput="checkStrength(this.value)"
                  class="input-magic w-full rounded-2xl px-6 py-5 outline-none text-white text-sm"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <span
                  class="absolute right-5 top-1/2 -translate-y-1/2 cursor-pointer opacity-40 hover:opacity-100"
                  onclick="togglePass('password')"
                  >ğŸ‘ï¸</span
                >
              </div>
              <div class="mt-4 px-1">
                <div class="bg-white/5 w-full h-1 rounded-full overflow-hidden">
                  <div id="meter" class="strength-bar"></div>
                </div>
                <div class="flex justify-between mt-2">
                  <span
                    id="strengthText"
                    class="text-[8px] font-black uppercase text-slate-600"
                    >Security Check</span
                  >
                  <span
                    id="strengthPercent"
                    class="text-[8px] font-mono text-slate-500"
                    >0%</span
                  >
                </div>
              </div>
            </div>

            <div>
              <label
                class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 ml-1"
                >Verify Key</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="confirmPassword"
                  class="input-magic w-full rounded-2xl px-6 py-5 outline-none text-white text-sm"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <span
                  class="absolute right-5 top-1/2 -translate-y-1/2 cursor-pointer opacity-40 hover:opacity-100"
                  onclick="togglePass('confirmPassword')"
                  >ğŸ‘ï¸</span
                >
              </div>
            </div>
          </div>

          <button
            onclick="handleRegister()"
            id="regBtn"
            class="w-full btn-magic-auth py-6 rounded-2xl text-[11px] uppercase tracking-[0.2em] active:scale-95 shadow-lg"
          >
            Initialize Neural ID
          </button>

          <p class="text-center text-[10px] text-slate-500">
            á˜á¶á“á‚áá“á¸ášá½á…á á¾á™?
            <a
              href="/login"
              class="text-purple-400 font-black hover:underline ml-1"
              >Secure Login</a
            >
          </p>
        </div>
      </div>
    </section>
  </div>
</main>

<%- include('partials/footer') %>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    GoogleAuthProvider,
    signInWithPopup,
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "<%= firebaseConfig.apiKey %>",
    authDomain: "<%= firebaseConfig.authDomain %>",
    projectId: "<%= firebaseConfig.projectId %>",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // áŸ¡. Interactive Magic Background (Mouse Follow)
  const canvas = document.getElementById("neural-bg");
  const ctx = canvas.getContext("2d");
  let dots = [];
  let mouse = { x: null, y: null };
  window.addEventListener("mousemove", (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
  });

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    dots = [];
    for (let i = 0; i < 60; i++) {
      dots.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        size: Math.random() * 2,
      });
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "<%= theme || '#a855f7' %>";
    ctx.strokeStyle = "rgba(168, 85, 247, 0.05)";
    dots.forEach((d) => {
      d.x += d.vx;
      d.y += d.vy;
      if (d.x < 0 || d.x > canvas.width) d.vx *= -1;
      if (d.y < 0 || d.y > canvas.height) d.vy *= -1;
      let dist = Math.hypot(mouse.x - d.x, mouse.y - d.y);
      if (dist < 150) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.stroke();
      }
      ctx.beginPath();
      ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  init();
  draw();
  window.addEventListener("resize", init);

  // áŸ¢. UI Helpers
  window.togglePass = (id) => {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
  };

  window.checkStrength = (pass) => {
    const meter = document.getElementById("meter");
    const text = document.getElementById("strengthText");
    const percent = document.getElementById("strengthPercent");
    let strength = 0;
    if (pass.length >= 8) strength += 25;
    if (pass.match(/[A-Z]/)) strength += 25;
    if (pass.match(/[0-9]/)) strength += 25;
    if (pass.match(/[^A-Za-z0-9]/)) strength += 25;

    meter.style.width = strength + "%";
    percent.innerText = strength + "%";
    if (strength <= 25) {
      meter.style.backgroundColor = "#ef4444";
      text.innerText = "Security: Weak";
      text.style.color = "#ef4444";
    } else if (strength <= 75) {
      meter.style.backgroundColor = "#f59e0b";
      text.innerText = "Security: Moderate";
      text.style.color = "#f59e0b";
    } else {
      meter.style.backgroundColor = "#10b981";
      text.innerText = "Security: Neural Grade";
      text.style.color = "#10b981";
    }
  };

  // áŸ£. Firebase Auth Handlers
  window.signInWithGoogle = async () => {
    const btn = document.getElementById("googleBtn");
    btn.innerText = "LINKING NEURAL PATH...";
    try {
      const result = await signInWithPopup(auth, provider);
      await sendTokenToBackend(result.user);
    } catch (error) {
      btn.innerText = "SYNC WITH GOOGLE CLOUD";
      showError(error.message);
    }
  };

  window.handleRegister = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const btn = document.getElementById("regBtn");

    if (!email || !password || !confirmPassword)
      return showError("áŸá¼á˜á”áŸ†á–áŸá‰ Identity á±áŸ’á™á‚áŸ’ášá”áŸ‹á”á„á”áŸ’ášá¼!");
    if (password !== confirmPassword)
      return showError("Password á‘á¶áŸ†á„á–á¸ášá˜á·á“áŠá¼á…á‚áŸ’á“á¶á‘áŸá”á„á”áŸ’ášá¼!");
    if (password.length < 8)
      return showError("Password ááŸ’ášá¼áœá˜á¶á“á™áŸ‰á¶á„áá·á… áŸ¨ ááŸ’á‘á„áŸ‹á¡á¾á„á‘áŸ…!");

    btn.innerText = "INITIALIZING CORE...";
    btn.classList.add("pointer-events-none", "opacity-50");

    try {
      const result = await createUserWithEmailAndPassword(
        auth,
        email,
        password,
      );
      await sendTokenToBackend(result.user);
    } catch (error) {
      btn.innerText = "Initialize Neural ID";
      btn.classList.remove("pointer-events-none", "opacity-50");
      showError(error.message);
    }
  };

  async function sendTokenToBackend(user) {
    const idToken = await user.getIdToken();
    const res = await fetch("/api/auth/session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idToken: idToken, isRegistering: true }),
    });
    if (res.ok) {
      window.location.href = "/dashboard";
    } else {
      const errData = await res.json();
      showError(errData.message);
    }
  }

  function showError(msg) {
    Swal.fire({
      icon: "error",
      title: "Neural Disruption",
      text: msg,
      background: "#020617",
      color: "#fff",
      confirmButtonColor: "#a855f7",
    });
  }
</script>
