<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    :root { 
        --primary: <%= theme || '#a855f7' %>; 
        --secondary: #6366f1;
        --bg: #020617; 
        --magic-glow: rgba(168, 85, 247, 0.2);
    }
    
    body {
        font-family: "Kantumruy Pro", sans-serif;
        background-color: var(--bg);
        color: #f3f4f6;
        overflow-x: hidden;
    }

    /* áŸ¢. Interactive Magic Background */
    #neural-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -20; opacity: 0.2; }
    .bg-grid {
        position: fixed; inset: 0;
        background-image: 
            linear-gradient(to right, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 50px 50px;
        mask-image: radial-gradient(circle at 50% 50%, black, transparent 90%);
        z-index: -10;
    }

    /* áŸ£. Magic Card Architecture */
    .magic-card {
        position: relative;
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(30px);
        border-radius: 45px;
        z-index: 1;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .magic-card::before {
        content: "";
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: conic-gradient(from 0deg, transparent, var(--primary), transparent 30%);
        animation: rotateMagic 10s linear infinite;
        z-index: -1;
        opacity: 0.15;
    }
    @keyframes rotateMagic { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* áŸ¤. Shimmer & Typography */
    .shimmer-text {
        background: linear-gradient(90deg, #fff, var(--primary), #fff);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 5s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .search-glass {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 35px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* Markdown Rendering Styling */
    .prose-archive { line-height: 1.8; color: #cbd5e1; }
    .prose-archive strong { color: var(--primary); text-shadow: 0 0 10px var(--magic-glow); }
    .prose-archive p { margin-bottom: 1.25rem; }
    .prose-archive ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 1rem; }

    .float-ui { animation: float 4s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
</style>

<canvas id="neural-bg"></canvas>
<div class="bg-grid"></div>

<main class="max-w-7xl mx-auto p-6 md:p-12 relative">
    <header class="text-center mb-20 space-y-6 animate-in fade-in slide-in-from-top-10 duration-1000">
        <div class="inline-flex items-center gap-3 px-6 py-2 rounded-full bg-purple-500/10 border border-purple-500/20 float-ui">
            <span class="w-2 h-2 rounded-full bg-purple-400 animate-ping"></span>
            <span class="text-purple-400 text-xs font-black tracking-widest uppercase">Decrypted MongoDB Atlas Memories</span>
        </div>
        <h2 class="text-6xl md:text-9xl font-black shimmer-text italic uppercase leading-none">Neural Archive</h2>
        <p class="text-slate-500 text-sm font-light italic max-w-2xl mx-auto leading-relaxed px-4">
            "ášá¶á›áŸ‹áŠá¶á“á‡á¾á„á˜áŸášáŸ€á“áŠáŸ‚á›á”áŸ’á¢á¼á“á”á¶á“á…á¶ášá‘á»á€ ááŸ’ášá¼áœá”á¶á“ášá€áŸ’áŸá¶á€áŸ’á“á»á„á€áŸ’ášá¶áŸ†á„á˜á¶áŸáŒá¸á‡á¸áá›á‡á¶ášáŸ€á„ášá á¼ááŸ” áŸáŸ’áœáŸ‚á„ášá€ á“á·á„ášáŸ†á›á¹á€á…áŸ†ááŸáŸ‡áŠá¹á„ášá”áŸáŸ‹á”áŸ’á¢á¼á“á“áŸ…á‘á¸á“áŸáŸ‡!"
        </p>
    </header>

    <div class="search-glass p-8 mb-24 sticky top-6 z-40 transition-all">
        <form action="/history" method="GET" class="flex flex-col lg:flex-row gap-6">
            <div class="flex-1 relative group">
                <input type="text" name="search" value="<%= currentSearch %>"
                    class="w-full bg-black/40 border border-white/5 rounded-2xl px-8 py-5 outline-none focus:border-purple-500 transition-all text-white text-lg placeholder:text-slate-700 shadow-inner"
                    placeholder="áŸáŸ’áœáŸ‚á„ášá€áŠá¶á“á‡á¾á„á˜áŸášáŸ€á“ (á§. Python, MLBB, Laravel)...">
                <span class="absolute right-8 top-1/2 -translate-y-1/2 opacity-20 text-[10px] font-mono tracking-widest">SEARCH_ENGINE_V2.6</span>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <select name="tool" class="bg-black/60 border border-white/5 rounded-2xl px-8 py-5 outline-none focus:border-purple-500 text-slate-300 text-xs font-black uppercase tracking-widest cursor-pointer">
                    <option value="ALL" <%= currentTool === 'ALL' ? 'selected' : '' %>>All Sectors</option>
                    <option value="AI_TUTOR" <%= currentTool === 'AI_TUTOR' ? 'selected' : '' %>>AI Tutor</option>
                    <option value="CODE_REVIEWER" <%= currentTool === 'CODE_REVIEWER' ? 'selected' : '' %>>Reviewer</option>
                    <option value="K_IDA" <%= currentTool === 'K_IDA' ? 'selected' : '' %>>K-IDA Chat</option>
                    <option value="STUDY_ASSISTANT" <%= currentTool === 'STUDY_ASSISTANT' ? 'selected' : '' %>>Study Buddy</option>
                </select>

                <button type="submit" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-14 py-5 rounded-2xl font-black text-xs transition-all active:scale-90 shadow-2xl uppercase tracking-widest hover:brightness-125">
                    Execute Filter
                </button>
            </div>
        </form>
    </div>

    <div class="space-y-16">
        <% if (history.length > 0) { %>
            <% history.forEach(item => { %>
                <div class="magic-card p-10 md:p-16 group relative">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 mb-12 border-b border-white/5 pb-10">
                        <div class="flex flex-wrap items-center gap-6">
                            <span class="px-6 py-2.5 bg-white text-black rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg">
                                <%= item.toolName %>
                            </span>
                            <span class="text-slate-500 font-mono text-[10px] uppercase tracking-[0.3em]">
                                SYNC_TIMESTAMP: <%= new Date(item.createdAt).toLocaleString('km-KH', { hour12: true }) %>
                            </span>
                        </div>
                        <button onclick="copyEntry('<%= item._id %>')" class="text-[10px] font-black text-slate-500 hover:text-white uppercase transition-all tracking-widest flex items-center gap-2">
                            <span>ğŸ”—</span> Share_Unit_Log
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-16">
                        <div class="lg:col-span-2 space-y-6">
                            <h4 class="text-[10px] font-black text-slate-600 uppercase tracking-[0.5em] flex items-center gap-4">
                                <span class="h-1 w-8 bg-slate-800 rounded-full"></span> Human Intent Signal
                            </h4>
                            <p class="text-3xl text-white font-light italic leading-tight tracking-tight">"<%= item.userInput %>"</p>
                        </div>

                        <div class="lg:col-span-3 space-y-8">
                            <h4 class="text-[10px] font-black text-purple-400 uppercase tracking-[0.5em] flex items-center gap-4">
                                <span class="h-1 w-12 bg-purple-500 rounded-full shadow-[0_0_15px_var(--primary)]"></span> Neural Decryption Output
                            </h4>
                            
                            <div id="content-<%= item._id %>" class="prose-archive text-xl font-light">
                                </div>

                            <script>
                                (function() {
                                    // ášá€á…áŸ†áá»á…áŠáŸ‚á›á˜á¶á“á¢ááŸ’áá”á‘ (Handle strings and various object structures)
                                    const rawRes = <%- JSON.stringify(item.aiResponse) %>;
                                    let textToRender = "Memory Decrypted Successfully";
                                    
                                    if (typeof rawRes === 'string') {
                                        textToRender = rawRes;
                                    } else if (rawRes && typeof rawRes === 'object') {
                                        textToRender = rawRes.explanation || rawRes.response || rawRes.answer || rawRes.humorous_response || rawRes.summary || "Extraction Complete.";
                                    }
                                    
                                    document.getElementById("content-<%= item._id %>").innerHTML = marked.parse(textToRender);
                                })();
                            </script>

                            <% if (item.aiResponse && (item.aiResponse.fixed_code || item.aiResponse.full_code_snippet)) { %>
                                <div class="relative group/code mt-10">
                                    <div class="absolute -inset-1 bg-gradient-to-r from-purple-500 to-cyan-500 rounded-3xl blur opacity-10 group-hover/code:opacity-30 transition duration-1000"></div>
                                    <div class="relative bg-black/80 rounded-3xl border border-white/5 overflow-hidden">
                                        <div class="px-8 py-4 bg-white/5 border-b border-white/5 flex justify-between items-center">
                                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Fixed_Logic_Stream.js</span>
                                        </div>
                                        <pre class="p-8 overflow-x-auto no-scrollbar font-mono text-sm text-cyan-400"><code><%= item.aiResponse.fixed_code || item.aiResponse.full_code_snippet %></code></pre>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="magic-card p-32 text-center border-2 border-dashed border-white/5 animate-pulse">
                <div class="text-9xl mb-12 opacity-20 filter grayscale">ğŸ›¸</div>
                <h3 class="text-2xl font-black uppercase tracking-[0.6em] text-slate-600 mb-8">Neural Void Detected</h3>
                <p class="text-slate-500 italic max-w-md mx-auto text-lg leading-relaxed">
                    á”á„á”áŸ’ášá¼á¢á¾á™! á”áŸ’ášá–áŸá“áŸ’á’ášá€á˜á·á“áƒá¾á‰áŠá¶á“á‡á¾á„á˜áŸášáŸ€á“áŸáŸ„áŸ‡ á”áŸ’ášá áŸ‚á›á‡á¶á”á„á”áŸ’ášá¼á˜á·á“á‘á¶á“áŸ‹á”á¶á“ "á”á‰áŸ’á‡á¼á“áŸá‰áŸ’á‰á¶" (áŸá½áš AI) á˜áŸ‚á“á‘áŸ? ğŸ˜‚
                </p>
                <a href="/" class="mt-12 inline-block px-12 py-5 bg-purple-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-2xl hover:brightness-125 transition-all">Start New Mission</a>
            </div>
        <% } %>
    </div>
</main>

<%- include('partials/footer') %>

<script>
    // áŸ¡. Interactive Magic Background (Mouse Follow)
    const canvas = document.getElementById("neural-bg");
    const ctx = canvas.getContext("2d");
    let dots = [];
    let mouse = { x: null, y: null };
    window.addEventListener("mousemove", (e) => { mouse.x = e.x; mouse.y = e.y; });

    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        dots = [];
        const count = window.innerWidth < 768 ? 40 : 80;
        for (let i = 0; i < count; i++) {
            dots.push({ 
                x: Math.random() * canvas.width, 
                y: Math.random() * canvas.height, 
                vx: (Math.random() - 0.5) * 0.4, 
                vy: (Math.random() - 0.5) * 0.4, 
                size: Math.random() * 2 
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "<%= theme || '#a855f7' %>";
        ctx.strokeStyle = "rgba(168, 85, 247, 0.05)";
        dots.forEach(d => {
            d.x += d.vx; d.y += d.vy;
            if (d.x < 0 || d.x > canvas.width) d.vx *= -1; if (d.y < 0 || d.y > canvas.height) d.vy *= -1;
            let dist = Math.hypot(mouse.x - d.x, mouse.y - d.y);
            if (dist < 150) { ctx.beginPath(); ctx.moveTo(d.x, d.y); ctx.lineTo(mouse.x, mouse.y); ctx.stroke(); }
            ctx.beginPath(); ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2); ctx.fill();
        });
        requestAnimationFrame(draw);
    }
    init(); draw();
    window.addEventListener("resize", init);

    // áŸ¢. Copy Entry Logic
    async function copyEntry(id) {
        Swal.fire({
            icon: 'info',
            title: 'Neural Link Active',
            text: 'á€áŸ†á–á»á„á‘á¶á‰á™á€ááŸ†áá—áŸ’á‡á¶á”áŸ‹áŸá˜áŸ’ášá¶á”áŸ‹ Log ID: ' + id,
            background: '#020617',
            color: '#fff',
            timer: 1500,
            showConfirmButton: false,
            customClass: { popup: 'rounded-[35px] border border-white/10 shadow-2xl' }
        });
    }
</script>