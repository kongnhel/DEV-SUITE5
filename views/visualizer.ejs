<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

<style>
  :root {
    --primary: <%= theme || "#00ff41" %>;
    --secondary: #059669;
    --bg: #020617;
    --magic-glow: rgba(0, 255, 65, 0.2);
  }
  body {
    font-family: "Kantumruy Pro", sans-serif;
    background-color: var(--bg);
    color: #f8fafc;
    overflow-x: hidden;
  }

  /* áŸ¡. Interactive Magic Background */
  #neural-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -20;
    opacity: 0.2;
  }
  .bg-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(to right, rgba(0, 255, 65, 0.03) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    mask-image: radial-gradient(circle at 50% 50%, black, transparent 95%);
    z-index: -10;
  }

  /* áŸ¢. Magic Card Architecture */
  .magic-card {
    position: relative;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(30px);
    border-radius: 40px;
    z-index: 1;
    overflow: hidden;
    border: 1px solid rgba(0, 255, 65, 0.1);
  }
  .magic-card::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      transparent,
      var(--primary),
      transparent 30%
    );
    animation: rotateMagic 8s linear infinite;
    z-index: -1;
    opacity: 0.15;
  }
  @keyframes rotateMagic {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* áŸ£. Shimmer & UI Effects */
  .shimmer-text {
    background: linear-gradient(90deg, #fff, var(--primary), #fff);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 5s linear infinite;
  }
  @keyframes shine {
    to {
      background-position: 200% center;
    }
  }

  .float-ui {
    animation: float 4s ease-in-out infinite;
  }
  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  .btn-magic {
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    color: #000;
    font-weight: 900;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 20px var(--magic-glow);
  }
  .btn-magic:hover {
    transform: scale(1.05) translateY(-3px);
    box-shadow: 0 0 40px var(--primary);
  }

  /* Diagram Custom Styles */
  #diagramContainer {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 30px;
    border: 1px dashed rgba(0, 255, 65, 0.2);
  }
</style>

<canvas id="neural-bg"></canvas>
<div class="bg-grid"></div>

<main class="max-w-7xl mx-auto p-4 md:p-12 relative">
  <header
    class="text-center mb-20 space-y-10 animate-in fade-in zoom-in duration-1000"
  >
    <div
      class="inline-flex items-center gap-3 px-6 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 float-ui"
    >
      <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
      <span
        class="text-emerald-400 text-xs font-black tracking-widest uppercase"
        >System Logic Engine V2.6</span
      >
    </div>

    <h2
      class="text-6xl md:text-9xl font-black tracking-tighter shimmer-text italic uppercase leading-none"
    >
      LOGIC VISUALIZER
    </h2>

    <div class="max-w-4xl mx-auto space-y-8">
      <p class="text-3xl md:text-5xl font-light text-white leading-tight">
        "áˆá”áŸ‹áœá„áŸ’áœáŸá„á€áŸ’á“á»á„á€á¼áŠášá¶á”áŸ‹á–á¶á“áŸ‹á”á“áŸ’á‘á¶ááŸ‹! á±áŸ’á™á”á„ AI á”áŸ†á”áŸ’á›áŸ‚á„áœá¶á‘áŸ…á‡á¶
        <span class="text-emerald-400 font-bold">á•áŸ‚á“á‘á¸á˜á“áŸ’áá¢á¶á‚á˜</span> áœá·á‰!"
      </p>
      <p
        class="text-lg md:text-xl text-slate-400 font-light italic leading-relaxed px-4"
      >
        áá¾á”áŸ’á¢á¼á“á’áŸ’á›á¶á”áŸ‹áœá·á›á˜á»áá“á¹á„á€á¶ášá¢á¶á“ Logic áŸáŸ’á˜á»á‚áŸáŸ’á˜á¶á‰á˜áŸ‚á“á‘áŸ?
        <strong class="text-emerald-400">Logic Visualizer</strong> á“á¹á„á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹
        <span class="underline decoration-emerald-500/30">Neural Mapping</span>
        áŠá¾á˜áŸ’á”á¸á”áŸ†á”áŸ’á›áŸ‚á„á€á¼áŠá”áŸ’á¢á¼á“á±áŸ’á™á€áŸ’á›á¶á™á‡á¶ Flowchart áŠáŸáŸáŸ’ášáŸáŸ‹áŸáŸ’á¢á¶áá—áŸ’á›á¶á˜áŸ—áŸ”
        á‡á½á™á±áŸ’á™á™á›áŸ‹á–á¸áŠáŸ†áá¾ášá€á¶ášá€á¼áŠ á“á·á„ášá€áƒá¾á‰ Bug á”á¶á“á›á¿á“á‡á¶á„á˜á»á“ áŸ¡áŸ áŠá„! ğŸš€
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-10">
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ—ºï¸
        </div>
        <h4 class="text-emerald-400 font-black uppercase mb-3">
          Instant Mapping
        </h4>
        <p class="text-sm text-slate-400 italic">
          á‚áŸ’ášá¶á“áŸ‹ááŸ‚á”áŸ„áŸ‡á€á¼áŠá…á¼á›á˜á€ á•áŸ‚á“á‘á¸ Logic á“á¹á„á›áŸá…á¡á¾á„á€áŸ’á“á»á„á˜á½á™á–á–áŸ’ášá·á…á—áŸ’á“áŸ‚á€áŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ•µï¸
        </div>
        <h4 class="text-emerald-400 font-black uppercase mb-3">Logic Debug</h4>
        <p class="text-sm text-slate-400 italic">
          á˜á¾á›áƒá¾á‰ášá¶á›áŸ‹á›á€áŸ’ááááŸ’áŒ (If/Else, Loops) á™áŸ‰á¶á„á…áŸ’á”á¶áŸáŸ‹á›á¶áŸáŸ‹á”áŸ†á•á»ááŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ–¼ï¸
        </div>
        <h4 class="text-emerald-400 font-black uppercase mb-3">Pro Export</h4>
        <p class="text-sm text-slate-400 italic">
          Export á‡á¶ SVG á‚á»áá—á¶á–ááŸ’á–áŸáŸ‹áŸá˜áŸ’ášá¶á”áŸ‹áŠá¶á€áŸ‹á€áŸ’á“á»á„ Report á¬ PresentationáŸ”
        </p>
      </div>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 md:gap-16 items-start">
    <div class="lg:col-span-5 space-y-10">
      <div class="magic-card p-8 md:p-12 shadow-2xl">
        <div class="flex items-center gap-4 mb-10">
          <div class="p-3 bg-emerald-500/10 rounded-2xl">
            <span class="text-3xl">ğŸ’»</span>
          </div>
          <div>
            <h3
              class="text-lg font-black text-white uppercase tracking-tighter"
            >
              Source Ingest
            </h3>
            <p class="text-xs text-slate-500">á”á‰áŸ’á…á¼á›á€á¼áŠá”áŸ’á¢á¼á“áá¶á„á€áŸ’ášáŸ„á˜</p>
          </div>
        </div>

        <textarea
          id="codeInput"
          class="w-full h-64 md:h-[500px] bg-black/40 border border-white/5 rounded-[30px] p-8 focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all font-mono text-base leading-relaxed text-emerald-400 no-scrollbar shadow-inner"
          placeholder="á§á‘á¶á ášááŸáŸ–&#10;if (userIsRich) {&#10;  buyTesla();&#10;} else {&#10;  buyBicycle();&#10;}"
        ></textarea>

        <button
          onclick="visualize()"
          id="btnAction"
          class="btn-magic w-full mt-10 py-7 rounded-[35px] text-xl uppercase tracking-[0.3em] flex justify-center items-center gap-5 active:scale-90"
        >
          <span>Generate Flow</span>
        </button>
      </div>
    </div>

    <div class="lg:col-span-7">
      <div
        class="magic-card p-6 md:p-12 flex flex-col min-h-[600px] md:min-h-[800px]"
      >
        <div
          class="p-6 border-b border-white/5 flex justify-between items-center mb-8"
        >
          <div class="flex items-center gap-3">
            <div class="h-2 w-2 rounded-full bg-emerald-500 animate-ping"></div>
            <span
              class="text-[11px] font-black text-slate-400 uppercase tracking-widest"
              >Neural Diagram Output</span
            >
          </div>
          <div id="controlPanel" class="hidden flex gap-4">
            <button
              onclick="downloadSVG()"
              class="text-xs bg-white/5 hover:bg-emerald-500 hover:text-black px-6 py-2.5 rounded-full border border-white/10 transition-all font-black uppercase tracking-widest shadow-lg"
            >
              Export_SVG
            </button>
          </div>
        </div>

        <div
          class="flex-grow flex items-center justify-center relative overflow-hidden"
        >
          <div id="loading" class="hidden text-center">
            <div class="relative w-24 h-24 mx-auto mb-10">
              <div
                class="absolute inset-0 border-8 border-white/5 rounded-full"
              ></div>
              <div
                class="absolute inset-0 border-8 border-t-emerald-500 rounded-full animate-spin"
              ></div>
            </div>
            <p
              class="text-emerald-500 font-mono text-xs animate-pulse tracking-[0.5em] uppercase"
            >
              Mapping_Logic...
            </p>
          </div>

          <div
            id="resultContainer"
            class="hidden w-full h-full flex flex-col items-center"
          >
            <div
              id="diagramContainer"
              class="p-10 no-scrollbar w-full flex justify-center overflow-x-auto"
            >
              <div
                id="mermaidGraph"
                class="mermaid scale-110 md:scale-125"
              ></div>
            </div>
            <div
              class="mt-10 p-8 bg-emerald-500/5 rounded-3xl border border-emerald-500/10 text-center w-full"
            >
              <p class="text-base text-slate-400 italic">
                ğŸ’¡ á‚á“áŸ’á›á¹áŸ‡áŸ– Logic á“áŸáŸ‡ááŸ’ášá¼áœá”á¶á“áœá·á—á¶á‚áŠáŸ„á™ AI
                áŠá¾á˜áŸ’á”á¸á±áŸ’á™á”áŸ’á¢á¼á“á„á¶á™áŸáŸ’ášá½á›á™á›áŸ‹á”áŸ†á•á»á!
              </p>
            </div>
          </div>

          <div id="placeholder" class="text-center space-y-6 opacity-30">
            <p class="text-xs font-mono uppercase tracking-[0.5em]">
              Waiting for logic signals...
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>

<script>
  const socket = io();

  // áŸ¡. Interactive Magic Background (Mouse Follow)
  const canvas = document.getElementById("neural-bg");
  const ctx = canvas.getContext("2d");
  let dots = [];
  let mouse = { x: null, y: null };
  window.addEventListener("mousemove", (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
  });

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    dots = [];
    for (let i = 0; i < 70; i++) {
      dots.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        size: Math.random() * 1.5,
      });
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "<%= theme || '#00ff41' %>";
    ctx.strokeStyle = "rgba(0, 255, 65, 0.05)";
    dots.forEach((d) => {
      d.x += d.vx;
      d.y += d.vy;
      if (d.x < 0 || d.x > canvas.width) d.vx *= -1;
      if (d.y < 0 || d.y > canvas.height) d.vy *= -1;

      let dist = Math.hypot(mouse.x - d.x, mouse.y - d.y);
      if (dist < 150) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.stroke();
      }

      ctx.beginPath();
      ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  init();
  draw();

  // áŸ¢. Mermaid Interaction Logic
  mermaid.initialize({
    startOnLoad: false,
    theme: "dark",
    flowchart: { useMaxWidth: true, htmlLabels: true, curve: "basis" },
    themeVariables: {
      fontFamily: "Kantumruy Pro",
      primaryColor: "#00ff41",
      nodeTextColor: "#ffffff",
    },
  });

  async function visualize() {
    const code = document.getElementById("codeInput").value.trim();
    const firebaseUid = "<%= user ? user.firebaseUid : '' %>";

    if (!code)
      return Swal.fire({
        icon: "warning",
        title: "Empty Logic",
        text: "áŠá¶á€áŸ‹á€á¼áŠá˜á€á”áŸ’á¢á¼á“!",
        background: "#020617",
        color: "#00ff41",
      });
    if (!firebaseUid)
      return Swal.fire({
        icon: "warning",
        title: "Identity Unknown",
        text: "áŸá¼á˜ Login áŸá·á“ áŠá¾á˜áŸ’á”á¸ášá€áŸ’áŸá¶á‘á»á€ History!",
        background: "#020617",
        color: "#00ff41",
      });

    document.getElementById("placeholder").classList.add("hidden");
    document.getElementById("loading").classList.remove("hidden");
    document.getElementById("resultContainer").classList.add("hidden");
    document.getElementById("btnAction").disabled = true;

    socket.emit("visualize_logic", { code, firebaseUid });
  }

  socket.on("visualize_result", async (data) => {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("resultContainer").classList.remove("hidden");
    document.getElementById("controlPanel").classList.remove("hidden");
    document.getElementById("btnAction").disabled = false;

    const container = document.getElementById("mermaidGraph");
    container.removeAttribute("data-processed");
    container.innerHTML = data.mermaidCode;

    try {
      await mermaid.run({ nodes: [container] });
      document
        .getElementById("resultContainer")
        .scrollIntoView({ behavior: "smooth" });
    } catch (err) {
      container.innerHTML =
        "<div class='text-red-400 p-10 bg-red-500/10 rounded-[30px] text-center'>ğŸ’€ á”á„á‚á¼ášá¢ááŸ‹á…áŸá‰á‘áŸ á€á¼áŠá“áŸáŸ‡áŸáŸ’á˜á»á‚áŸáŸ’á˜á¶á‰á–áŸá€!</div>";
    }
  });

  function downloadSVG() {
    const svg = document.querySelector("#mermaidGraph svg");
    if (!svg) return;
    const svgData = new XMLSerializer().serializeToString(svg);
    const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `logic_flow_${Date.now()}.svg`;
    link.click();
  }

  window.addEventListener("resize", init);
</script>
