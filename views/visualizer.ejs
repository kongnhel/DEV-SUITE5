<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

<style>
    :root {
        --primary: <%= theme %>; /* Matrix Green from Controller */
        --bg: #020617;
    }
    body {
        background-color: var(--bg);
        color: #f8fafc;
        font-size: 16px;
    }

    /* Marketing & Visual Overhaul */
    .bg-grid {
        position: fixed;
        inset: 0;
        background-image: 
            linear-gradient(to right, rgba(0, 255, 65, 0.04) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(0, 255, 65, 0.04) 1px, transparent 1px);
        background-size: 40px 40px;
        mask-image: radial-gradient(circle at 50% 50%, black, transparent 95%);
        z-index: -20;
    }

    .glass-panel {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(0, 255, 65, 0.1);
        border-radius: 40px;
        transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glass-panel:hover {
        border-color: rgba(0, 255, 65, 0.3);
        box-shadow: 0 0 50px rgba(0, 255, 65, 0.05);
    }

    .btn-logic {
        background: linear-gradient(135deg, #059669 0%, var(--primary) 100%);
        box-shadow: 0 0 25px rgba(0, 255, 65, 0.2);
        transition: 0.3s;
    }
    .btn-logic:hover {
        box-shadow: 0 0 40px rgba(0, 255, 65, 0.4);
        transform: translateY(-2px);
    }

    #diagramContainer {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 24px;
        border: 1px dashed rgba(0, 255, 65, 0.2);
        min-height: 500px;
    }

    .shimmer-text {
        background: linear-gradient(90deg, #fff, var(--primary), #fff);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 4s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }
</style>

<div class="bg-grid"></div>

<main class="max-w-7xl mx-auto p-4 md:p-12 relative">
    
    <header class="text-center mb-16 space-y-6 animate-in fade-in zoom-in duration-1000">
        <div class="inline-block px-4 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-black tracking-[0.4em] uppercase">
            âš¡ Code-to-Logic Protocol Activated
        </div>
        
        <h2 class="text-6xl md:text-9xl font-black tracking-tighter shimmer-text italic uppercase leading-none">
            LOGIC <span class="underline decoration-emerald-500/30">VISUALIZER</span>
        </h2>
        
        <div class="max-w-3xl mx-auto">
            <p class="text-2xl md:text-4xl font-light text-white leading-tight mb-6">
                "á€á»áŸ†á±áŸ’á™á€á¼áŠášá¶á”áŸ‹á–á¶á“áŸ‹á”á“áŸ’á‘á¶ááŸ‹ á’áŸ’áœá¾á±áŸ’á™á”áŸ’á¢á¼á“áœá„áŸ’áœáŸá„á•áŸ’á›á¼áœ!"
            </p>
            <p class="text-lg md:text-xl text-slate-400 font-light italic">
                á”áŸ†á”áŸ’á›áŸ‚á„á€á¼áŠáŠáŸáŸáŸ’á˜á»á‚áŸáŸ’á˜á¶á‰ á±áŸ’á™á€áŸ’á›á¶á™á‡á¶ <span class="text-emerald-500 font-bold">Flowchart</span> áŠáŸá…áŸ’á”á¶áŸáŸ‹á›á¶áŸáŸ‹ááŸ’ášá¹á˜ááŸ‚á˜á½á™á–á–áŸ’ášá·á…á—áŸ’á“áŸ‚á€áŸ” á‡á½á™á±áŸ’á™á”áŸ’á¢á¼á“á™á›áŸ‹á–á¸áŠáŸ†áá¾ášá€á¶ášá€á¼áŠ (Logic Flow) á“á·á„ášá€áƒá¾á‰ Bug á”á¶á“á›á¿á“á‡á¶á„á˜á»á“ áŸ¡áŸ áŠá„! ğŸš€
            </p>
        </div>

        <div class="flex flex-wrap justify-center gap-10 pt-8">
            <div class="text-center">
                <span class="text-3xl block mb-2">ğŸ—ºï¸</span>
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Auto Mapping</p>
            </div>
            <div class="text-center border-x border-white/10 px-10">
                <span class="text-3xl block mb-2">ğŸ•µï¸</span>
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Logic Debugging</p>
            </div>
            <div class="text-center">
                <span class="text-3xl block mb-2">ğŸ–¼ï¸</span>
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">SVG Export</p>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 md:gap-12 items-start">
        
        <div class="lg:col-span-5 space-y-6">
            <div class="glass-panel p-8 md:p-12 relative overflow-hidden">
                <div class="flex items-center gap-4 mb-10">
                    <div class="p-3 bg-emerald-500/10 rounded-2xl">
                        <span class="text-3xl">ğŸ’»</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-white uppercase tracking-tighter">Source Code Ingest</h3>
                        <p class="text-xs text-slate-500">á”á‰áŸ’á…á¼á›á€á¼áŠáŠáŸ‚á›á”áŸ’á¢á¼á“á…á„áŸ‹á”áŸ†á”áŸ’á›áŸ‚á„</p>
                    </div>
                </div>

                <textarea 
                    id="codeInput" 
                    class="w-full h-64 md:h-[500px] bg-black/40 border border-white/5 rounded-[30px] p-8 focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all font-mono text-base leading-relaxed text-emerald-400 no-scrollbar shadow-inner"
                    placeholder="á§á‘á¶á ášááŸáŸ–&#10;if (userIsRich) {&#10;  buyTesla();&#10;} else {&#10;  buyBicycle();&#10;}"></textarea>
                
                <button 
                    onclick="visualize()" 
                    id="btnAction"
                    class="btn-logic w-full mt-10 py-6 rounded-[30px] font-black text-lg text-white tracking-[0.2em] uppercase flex justify-center items-center gap-4 active:scale-95">
                    <span>GENERATE FLOW</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="lg:col-span-7">
            <div class="glass-panel p-4 md:p-10 flex flex-col min-h-[600px] md:min-h-[800px]">
                <div class="p-6 border-b border-white/5 flex justify-between items-center mb-8">
                    <div class="flex items-center gap-3">
                        <div class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Neural Logic Diagram Output</span>
                    </div>
                    <div id="controlPanel" class="hidden flex gap-4">
                        <button onclick="downloadSVG()" class="text-xs bg-white/5 hover:bg-emerald-500 hover:text-black px-6 py-2.5 rounded-full border border-white/10 transition-all font-black uppercase tracking-widest shadow-lg">Export_SVG</button>
                    </div>
                </div>

                <div class="flex-grow flex items-center justify-center relative overflow-hidden">
                    <div id="loading" class="hidden text-center">
                        <div class="relative w-24 h-24 mx-auto mb-10">
                            <div class="absolute inset-0 border-4 border-emerald-500/10 rounded-full"></div>
                            <div class="absolute inset-0 border-4 border-t-emerald-500 rounded-full animate-spin"></div>
                        </div>
                        <p class="text-emerald-500 font-mono text-xs animate-pulse tracking-[0.5em] uppercase">Mapping_Neural_Logic...</p>
                    </div>

                    <div id="resultContainer" class="hidden w-full h-full flex flex-col items-center">
                        <div id="diagramContainer" class="p-8 md:p-14 no-scrollbar w-full flex justify-center">
                            <div id="mermaidGraph" class="mermaid scale-110 md:scale-125"></div>
                        </div>
                        <div class="mt-10 p-6 bg-emerald-500/5 rounded-3xl border border-emerald-500/10 text-center w-full">
                            <p class="text-base text-slate-400 italic">ğŸ’¡ á‚á“áŸ’á›á¹áŸ‡áŸ– á”áŸ’á¢á¼á“á¢á¶á… Export á‡á¶ SVG áŠá¾á˜áŸ’á”á¸áŠá¶á€áŸ‹á€áŸ’á“á»á„ Report á¬ Presentation á±áŸ’á™á˜á¾á›á‘áŸ…á¡á¼á™á‡á¶á„á‚áŸ!</p>
                        </div>
                    </div>

                    <div id="placeholder" class="text-center space-y-6 opacity-30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 002-2h-2a2 2 0 00-2 2" />
                        </svg>
                        <p class="text-xs font-mono uppercase tracking-[0.5em]">Waiting for neural input...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<%- include('partials/footer') %>

<script>
    const socket = io();
    
    mermaid.initialize({ 
        startOnLoad: false, 
        theme: 'dark',
        securityLevel: 'loose',
        flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
        themeVariables: {
            fontSize: '16px',
            fontFamily: 'Kantumruy Pro',
            primaryColor: '#00ff41',
            edgeLabelBackground: '#020617',
            nodeTextColor: '#ffffff'
        }
    });

    async function visualize() {
        const code = document.getElementById("codeInput").value;
        if (!code) return Swal.fire({ 
            icon: 'warning', 
            title: 'áŠá¶á€áŸ‹á€á¼áŠá˜á€á”áŸ’á¢á¼á“!', 
            text: 'á”á„á‚áŸ’á˜á¶á“á˜á“áŸ’áá¢á¶á‚á˜á‚á¼ášášá¼á”á…áŸá‰á–á¸ááŸ’á™á›áŸ‹á‘áŸáá¶! ğŸ˜‚', 
            background: '#020617', 
            color: '#00ff41',
            confirmButtonColor: '#059669'
        });

        document.getElementById("placeholder").classList.add("hidden");
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("resultContainer").classList.add("hidden");
        document.getElementById("controlPanel").classList.add("hidden");
        document.getElementById("btnAction").disabled = true;
        document.getElementById("btnAction").style.opacity = "0.5";

        socket.emit("visualize_logic", { code });
    }

    socket.on("visualize_result", async (data) => {
        const { mermaidCode } = data;
        const container = document.getElementById("mermaidGraph");
        
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("resultContainer").classList.remove("hidden");
        document.getElementById("controlPanel").classList.remove("hidden");
        document.getElementById("btnAction").disabled = false;
        document.getElementById("btnAction").style.opacity = "1";

        container.removeAttribute("data-processed");
        container.innerHTML = mermaidCode;
        
        try {
            await mermaid.run({ nodes: [container] });
        } catch (err) {
            container.innerHTML = "<div class='text-red-400 p-10 bg-red-500/10 rounded-[30px] border border-red-500/20 text-center text-xl italic'>ğŸ’€ á¢á¼á™! á€á¼áŠá“áŸáŸ‡áŸáŸ’á˜á»á‚áŸáŸ’á˜á¶á‰áŠá›áŸ‹ááŸ’á“á¶á€áŸ‹á”á„áœá·á›á˜á»áá‚á¼ášá¢ááŸ‹á…áŸá‰á‘áŸ! áŸá»áŸ†á€á¼áŠáŸáŸ’ášá½á›áŸ—á”á“áŸ’áá·á…á˜á€!</div>";
        }
    });

    function downloadSVG() {
        const svg = document.querySelector("#mermaidGraph svg");
        if (!svg) return;
        const svgData = new XMLSerializer().serializeToString(svg);
        const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `neural_logic_flow_${Date.now()}.svg`;
        link.click();
        
        Swal.fire({ icon: 'success', title: 'ášá½á…ášá¶á›áŸ‹!', text: 'ášá¼á” Logic ááŸ’ášá¼áœá”á¶á“á‘á˜áŸ’á›á¶á€áŸ‹á…á¼á›á€áŸ’á“á»á„á˜áŸ‰á¶áŸáŸŠá¸á“á”áŸ’á¢á¼á“á á¾á™! âœ…', timer: 2000, showConfirmButton: false, background: '#020617', color: '#fff' });
    }

    socket.on('error_occured', (msg) => {
        Swal.fire({ icon: 'error', title: 'Error', text: msg, background: '#020617', color: '#fff' });
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("placeholder").classList.remove("hidden");
        document.getElementById("btnAction").disabled = false;
        document.getElementById("btnAction").style.opacity = "1";
    });
</script>