<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link
  href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&display=swap"
  rel="stylesheet"
/>

<style>
  :root {
    --royal-gold: <%= theme || "#d4af37" %>;
    --deep-bronze: #8b4513;
    --bg: #0a0a0a;
    --magic-glow: rgba(212, 175, 55, 0.3);
  }
  body {
    font-family: "Kantumruy Pro", sans-serif;
    background-color: var(--bg);
    color: #f3f4f6;
    overflow-x: hidden;
  }

  /* áŸ¡. Interactive Magic Background */
  #neural-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -20;
    opacity: 0.3;
  }
  .bg-pattern {
    position: fixed;
    inset: 0;
    background-image: url("https://www.transparenttextures.com/patterns/pinstriped-suit.png");
    opacity: 0.05;
    z-index: -15;
  }
  .hero-gold-glow {
    background: radial-gradient(
      circle at 50% 50%,
      rgba(212, 175, 55, 0.1) 0%,
      transparent 80%
    );
  }

  /* áŸ¢. Magic Card Architecture */
  .magic-card {
    position: relative;
    background: rgba(20, 20, 20, 0.7);
    backdrop-filter: blur(30px);
    border-radius: 40px;
    z-index: 1;
    overflow: hidden;
    border: 1px solid rgba(212, 175, 55, 0.1);
    transition: all 0.5s ease;
  }
  .magic-card::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      transparent,
      var(--royal-gold),
      transparent 30%
    );
    animation: rotateMagic 8s linear infinite;
    z-index: -1;
    opacity: 0.15;
  }
  @keyframes rotateMagic {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* áŸ£. Shimmer & Heritage Styles */
  .shimmer-gold {
    background: linear-gradient(90deg, #ffd700, #b8860b, #ffd700);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 5s linear infinite;
  }
  @keyframes shine {
    to {
      background-position: 200% center;
    }
  }

  .heritage-badge {
    background: rgba(212, 175, 55, 0.1);
    border: 1px solid rgba(212, 175, 55, 0.3);
    color: var(--royal-gold);
    padding: 8px 20px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 800;
    text-shadow: 0 0 10px var(--magic-glow);
  }

  .float-ui {
    animation: float 4s ease-in-out infinite;
  }
  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  .btn-khmer {
    background: linear-gradient(135deg, #b8860b 0%, #ffd700 50%, #b8860b 100%);
    color: #000 !important;
    font-weight: 900;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 25px var(--magic-glow);
  }
  .btn-khmer:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 0 45px var(--royal-gold);
  }

  /* Markdown Responsive Typography */
  .prose-custom {
    line-height: 1.8;
    color: #e5e7eb;
  }
  .prose-custom strong {
    color: var(--royal-gold);
    text-shadow: 0 0 10px var(--magic-glow);
  }
  .prose-custom h1,
  .prose-custom h2 {
    color: var(--royal-gold);
    margin-top: 1.5rem;
  }
</style>

<canvas id="neural-bg"></canvas>
<div class="bg-pattern"></div>
<div class="hero-gold-glow fixed inset-0 -z-10"></div>

<main class="max-w-7xl mx-auto p-4 md:p-12 relative">
  <header
    class="text-center mb-20 space-y-10 animate-in fade-in zoom-in duration-1000"
  >
    <div class="flex justify-center">
      <span class="heritage-badge uppercase float-ui"
        >Ancient Wisdom x Neural Intelligence</span
      >
    </div>

    <h2
      class="text-6xl md:text-9xl font-black tracking-tighter shimmer-gold leading-none pb-4 uppercase italic"
    >
      á˜á‚áŸ’á‚á»á‘áŸ’á‘áŸáŸá€áŸáœá”áŸ’á”á’á˜áŸŒááŸ’á˜áŸ‚áš
    </h2>

    <div class="max-w-4xl mx-auto space-y-8">
      <p class="text-3xl md:text-5xl font-light text-white leading-tight">
        "á”á¾á€á€áŸ’ášá¶áŸ†á„á˜á¶áŸá“áŸƒá”áŸ’ášáœááŸ’áá·áŸá¶áŸáŸ’ááŸ’ášááŸ’á˜áŸ‚áš áá¶á˜ášá™áŸˆ
        <span class="text-yellow-500 font-bold">á˜á“áŸ’áá¢á¶á‚á˜áŒá¸á‡á¸áá›</span>!"
      </p>
      <p
        class="text-lg md:text-xl text-slate-400 font-light italic leading-relaxed px-4"
      >
        áá¾á”áŸ’á¢á¼á“á…á„áŸ‹áŠá¹á„á–á¸á¢á¶ááŸŒá€áŸ†á”á¶áŸ†á„á“áŸƒá”áŸ’ášá¶áŸá¶á‘á”á»ášá¶á
        á¬á‘áŸ†á“áŸ€á˜á‘á˜áŸ’á›á¶á”áŸ‹ááŸ’á˜áŸ‚ášáŠáŸ‚á›á”á¶ááŸ‹á”á„áŸ‹á˜áŸ‚á“á‘áŸ?
        <strong class="text-yellow-600">AI Culture Guide</strong>
        á“á¹á„á€áŸ’á›á¶á™á‡á¶á˜á‚áŸ’á‚á»á‘áŸ’á‘áŸáŸá€áŸá†áŸ’á›á¶ááœáŸƒ
        á…á¶áŸ†á”á€áŸáŸ’ášá¶á™ášá¶á›áŸ‹á…á˜áŸ’á„á›áŸ‹áœá”áŸ’á”á’á˜áŸŒá‡á¼á“á”áŸ’á¢á¼á“á™áŸ‰á¶á„á€áŸ†á”áŸ’á›áŸ‚á„ á“á·á„áŸáŸŠá¸á‡á˜áŸ’ášáŸ…á”áŸ†á•á»ááŸ”
        á”áŸ„áŸ‡á…á˜áŸ’á„á›áŸ‹á”áŸ’á¢á¼á“á…á¼á›á˜á€ á…á¶áŸ†á”á„á‡á½á™á…á¶ášá€áŸ’á“á»á„á€áŸ’ášá¶áŸ†á„á˜á¶áŸá±áŸ’á™! ğŸ˜‚
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-10">
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ¯
        </div>
        <h4 class="text-yellow-500 font-black uppercase mb-3">
          Ancient Archives
        </h4>
        <p class="text-sm text-slate-400 italic">
          á‘á¶á‰á™á€á…áŸ†ááŸáŸ‡áŠá¹á„á–á¸áŸá˜áŸá™á˜á á¶á“á‚áš á˜á€á”á„áŸ’á á¶á‰á€áŸ’á“á»á„á˜á½á™á–á–áŸ’ášá·á…á—áŸ’á“áŸ‚á€áŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ“œ
        </div>
        <h4 class="text-yellow-500 font-black uppercase mb-3">
          Wise Storyteller
        </h4>
        <p class="text-sm text-slate-400 italic">
          á€á¶ášá”á€áŸáŸ’ášá¶á™á”áŸ‚á”á˜á“áŸ’áá¢á¶á‚á˜ á„á¶á™á™á›áŸ‹ á“á·á„á˜á¶á“áá»á„á€áŸ†á”áŸ’á›áŸ‚á„áŸ—áŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          âœ¨
        </div>
        <h4 class="text-yellow-500 font-black uppercase mb-3">Neural Wisdom</h4>
        <p class="text-sm text-slate-400 italic">
          á”áŸ’ášá¾á”á‰áŸ’á‰á¶áŸá·á”áŸ’á”á“á·á˜áŸ’á˜á·áá€á˜áŸ’ášá·áááŸ’á–áŸáŸ‹
          áŠá¾á˜áŸ’á”á¸á•áŸ’á‘áŸ€á„á•áŸ’á‘á¶ááŸ‹ášá¶á›áŸ‹á‘á·á“áŸ’á“á“áŸá™á”áŸ’ášáœááŸ’áá·áŸá¶áŸáŸ’ááŸ’ášáŸ”
        </p>
      </div>
    </div>
  </header>

  <div class="grid grid-cols-1 gap-12">
    <div class="magic-card p-8 md:p-16 relative shadow-2xl">
      <textarea
        id="questionInput"
        class="w-full h-40 md:h-56 bg-black/40 border border-white/10 rounded-[30px] p-8 focus:ring-4 focus:ring-yellow-500/20 outline-none text-xl md:text-2xl leading-relaxed text-slate-100 transition-all placeholder:text-slate-800 mb-10 shadow-inner"
        placeholder="á§á‘á¶á ášááŸáŸ– áá¾á”áŸ’ášá¶áŸá¶á‘á¢á„áŸ’á‚ášáœááŸ’áááŸ’ášá¼áœá”á¶á“á€áŸá¶á„á¡á¾á„á€áŸ’á“á»á„á‚áŸ„á›á”áŸ†áá„á¢áŸ’áœá¸?"
      ></textarea>

      <div
        class="flex flex-col lg:flex-row items-center justify-between gap-10"
      >
        <div class="w-full lg:w-1/2">
          <label
            class="block text-[11px] font-black text-yellow-600 uppercase tracking-[0.3em] mb-4 ml-4"
            >á”áŸ’ášá—áŸá‘á“áŸƒá€á¶ášá”á€áŸáŸ’ášá¶á™ (Wisdom Style)</label
          >
          <select
            id="answerType"
            class="w-full bg-black/60 border border-yellow-500/20 rounded-full px-8 py-5 text-lg text-yellow-200 outline-none appearance-none cursor-pointer"
          >
            <option value="brief">âœ¨ áŸá„áŸ’ááŸá”ááŸ’á›á¸ ááŸ’á›á¹á˜ (Brief Wisdom)</option>
            <option value="detailed">ğŸ“œ á–á“áŸ’á™á›áŸ‹á›á˜áŸ’á¢á·á (Ancient Archives)</option>
          </select>
        </div>
        <button
          onclick="askAI()"
          id="btnAsk"
          class="btn-khmer px-14 py-6 rounded-full text-xl shadow-2xl active:scale-90 flex items-center gap-4 w-full lg:w-auto justify-center uppercase tracking-widest"
        >
          <span id="btnText">áŸá¶á€áŸá½ášá¢áŸ’á“á€á‡áŸ†á“á¶á‰ AI</span>
        </button>
      </div>
    </div>

    <div id="loading" class="hidden py-24 text-center">
      <div class="relative w-24 h-24 mx-auto mb-10">
        <div
          class="absolute inset-0 border-8 border-yellow-500/10 rounded-full"
        ></div>
        <div
          class="absolute inset-0 border-8 border-t-yellow-500 rounded-full animate-spin"
        ></div>
      </div>
      <p
        class="mt-8 text-yellow-500 text-sm font-black animate-pulse uppercase tracking-[0.4em]"
      >
        á€áŸ†á–á»á„áŸáŸ’ášá¶áœá‡áŸ’ášá¶áœá€áŸ’ášá¶áŸ†á„á˜á¶áŸ...
      </p>
    </div>

    <div
      id="responseSection"
      class="hidden space-y-8 animate-in zoom-in-95 duration-1000"
    >
      <div
        class="magic-card p-10 md:p-16 border-l-[15px] border-yellow-600 relative"
      >
        <div
          class="text-[10px] font-black tracking-[0.5em] text-yellow-600/40 uppercase mb-10"
        >
          Chronicle Extraction Result
        </div>
        <div
          id="responseText"
          class="prose-custom text-lg md:text-2xl font-light italic"
        ></div>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>

<script>
  const socket = io();
  let isWaiting = false;

  // áŸ¡. Interactive Magic Background (Mouse Follow)
  const canvas = document.getElementById("neural-bg");
  const ctx = canvas.getContext("2d");
  let dots = [];
  let mouse = { x: null, y: null };
  window.addEventListener("mousemove", (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
  });

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    dots = [];
    for (let i = 0; i < 60; i++) {
      dots.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        size: Math.random() * 2,
      });
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "<%= theme || '#ffd700' %>";
    ctx.strokeStyle = "rgba(212, 175, 55, 0.1)";
    dots.forEach((d) => {
      d.x += d.vx;
      d.y += d.vy;
      if (d.x < 0 || d.x > canvas.width) d.vx *= -1;
      if (d.y < 0 || d.y > canvas.height) d.vy *= -1;

      let dist = Math.hypot(mouse.x - d.x, mouse.y - d.y);
      if (dist < 150) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.stroke();
      }

      ctx.beginPath();
      ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  init();
  draw();

  // áŸ¢. AI Interaction Logic
  function askAI() {
    if (isWaiting) return;
    const question = document.getElementById("questionInput").value.trim();
    const type = document.getElementById("answerType").value;
    const firebaseUid = "<%= user ? user.firebaseUid : '' %>";

    if (!firebaseUid)
      return Swal.fire({
        icon: "warning",
        title: "áŸá¼á˜á…á¼á›á‚áá“á¸áŸá·á“!",
        background: "#0a0a0a",
        color: "#ffd700",
      });
    if (!question)
      return Swal.fire({
        icon: "question",
        title: "áá¾á”áŸ’á¢á¼á“á…á„áŸ‹áŠá¹á„á¢áŸ’áœá¸áŠáŸ‚áš?",
        background: "#0a0a0a",
        color: "#ffd700",
      });

    toggleState(true);
    socket.emit("ask_culture", { question, type, firebaseUid });
  }

  socket.on("culture_result", (data) => {
    toggleState(false);
    document.getElementById("responseSection").classList.remove("hidden");
    document.getElementById("responseText").innerHTML = marked.parse(
      data.response,
    );
    document
      .getElementById("responseSection")
      .scrollIntoView({ behavior: "smooth" });
  });

  socket.on("error_occured", (msg) => {
    toggleState(false);
    Swal.fire({
      icon: "error",
      title: "Oops!",
      text: msg,
      background: "#0a0a0a",
      color: "#fff",
    });
  });

  function toggleState(loading) {
    isWaiting = loading;
    const btn = document.getElementById("btnAsk");
    const loader = document.getElementById("loading");
    btn.disabled = loading;
    if (loading) {
      loader.classList.remove("hidden");
      document.getElementById("responseSection").classList.add("hidden");
    } else {
      loader.classList.add("hidden");
    }
  }

  window.addEventListener("resize", init);
</script>
