<%- include('partials/header') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    --primary: <%= theme || "#ef4444" %>;
    --secondary: #ff8c00;
    --bg: #030712;
    --magic-glow: rgba(239, 68, 68, 0.3);
  }
  body {
    font-family: "Kantumruy Pro", sans-serif;
    background-color: var(--bg);
    color: #e2e8f0;
    overflow-x: hidden;
  }

  /* áŸ¡. Interactive Magic Background */
  #neural-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -20;
    opacity: 0.25;
  }
  .hero-gradient {
    background: radial-gradient(
      circle at 50% 50%,
      rgba(239, 68, 68, 0.1) 0%,
      transparent 80%
    );
  }

  /* áŸ¢. Magic Border Animation (á€á¼áŠá˜á€á–á¸á¢á“á¶á‚á) */
  .magic-card {
    position: relative;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(30px);
    border-radius: 40px;
    z-index: 1;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  .magic-card::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      transparent,
      var(--primary),
      transparent 30%
    );
    animation: rotateMagic 6s linear infinite;
    z-index: -1;
    opacity: 0.2;
  }
  @keyframes rotateMagic {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* áŸ£. Shimmer & Glow Effects */
  .shimmer-text {
    background: linear-gradient(
      90deg,
      #fff,
      var(--primary),
      var(--secondary),
      #fff
    );
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 5s linear infinite;
  }
  @keyframes shine {
    to {
      background-position: 200% center;
    }
  }

  /* áŸ¤. Hover & Floating Animation */
  .float-ui {
    animation: float 4s ease-in-out infinite;
  }
  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  .status-badge {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    color: var(--primary);
    padding: 6px 16px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 800;
    text-shadow: 0 0 10px var(--magic-glow);
  }

  .prose-kida {
    line-height: 1.8;
    font-size: 1.15rem;
    color: #cbd5e1;
  }
  .prose-kida strong {
    color: var(--primary);
    text-shadow: 0 0 10px var(--magic-glow);
  }

  .btn-magic {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff;
    font-weight: 900;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 20px var(--magic-glow);
  }
  .btn-magic:hover {
    transform: scale(1.05);
    box-shadow: 0 0 40px var(--primary);
  }
</style>

<canvas id="neural-bg"></canvas>
<div class="hero-gradient fixed inset-0 -z-10"></div>

<main class="max-w-7xl mx-auto p-4 md:p-12 relative">
  <header
    class="text-center mb-20 space-y-10 animate-in fade-in slide-in-from-top-10 duration-1000"
  >
    <div
      class="inline-flex items-center gap-3 px-6 py-2 rounded-full bg-red-500/10 border border-red-500/20 float-ui"
    >
      <span class="w-2 h-2 rounded-full bg-red-500 animate-ping"></span>
      <span
        class="text-red-500 text-xs font-black tracking-widest uppercase text-shadow"
        >K-IDA Neural Ingest V2.6</span
      >
    </div>

    <h2
      class="text-7xl md:text-9xl font-black tracking-tighter shimmer-text italic uppercase leading-none"
    >
      K-IDA
    </h2>

    <div class="max-w-4xl mx-auto space-y-8">
      <p class="text-3xl md:text-5xl font-light text-white leading-tight">
        "áˆá”áŸ‹áŸáŸŠá¼á‘áŸ’ášá¶áŸ†á“á¹á„ PDF ášá¶á”áŸ‹ášá™á‘áŸ†á–áŸáš! á±áŸ’á™ K-IDA á€áŸ’á›á¶á™á‡á¶
        <span class="text-red-500 font-bold">á˜á“áŸ’áá¢á¶á‚á˜</span> á“áŸƒá…áŸ†ááŸáŸ‡áŠá¹á„á”áŸ’á¢á¼á“!"
      </p>
      <p
        class="text-lg md:text-xl text-slate-400 font-light italic leading-relaxed px-4"
      >
        á”áŸ’á¢á¼á“á’á»á‰á“á¹á„á€á¶ášá¢á„áŸ’á‚á»á™á¢á¶á“á¯á€áŸá¶ášá˜áŸ‚á“á‘áŸ?
        <strong class="text-red-500">K-IDA</strong> á“á¹á„á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹
        <span class="underline decoration-red-500/30"
          >Intelligence Extraction</span
        >
        áŠá¾á˜áŸ’á”á¸á¢á¶á“ á“á·á„á™á›áŸ‹á‚áŸ’ášá”áŸ‹á…áŸ†áá»á…á€áŸ’á“á»á„ PDF á”áŸ’á¢á¼á“áŸ” á”áŸ„áŸ‡á¯á€áŸá¶ášá…á¼á›á˜á€
        ášá½á…áŸá½ášá…á„áŸ‹áŠá¹á„á¢á¸á€áŸá”á¶á“
        áœá¶á“á¹á„á†áŸ’á›á¾á™á™áŸ‰á¶á„á›á˜áŸ’á¢á·ááŠá¼á…á˜á¶á“á¢áŸ’á“á€á‡áŸ†á“á¶á‰á“áŸ…á€áŸ’á”áŸ‚ášááŸ’á›á½á“á¢áŸŠá¸á…á¹á„! ğŸ˜‚
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-10">
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ”
        </div>
        <h4 class="text-red-500 font-black uppercase mb-3">Instant Scan</h4>
        <p class="text-sm text-slate-400 italic">
          á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™á™áŸ‰á¶á„á áŸ’á˜ááŸ‹á…ááŸ‹á–á¸ PDF á‚áŸ’ášá”áŸ‹á”áŸ’ášá—áŸá‘á€áŸ’á“á»á„áœá·á“á¶á‘á¸áŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ§ 
        </div>
        <h4 class="text-red-500 font-black uppercase mb-3">Deep Context</h4>
        <p class="text-sm text-slate-400 italic">
          á™á›áŸ‹á–á¸ááŸ’á›á¹á˜áŸá¶ášá˜áŸášáŸ€á“á‘á¶áŸ†á„á˜á¼á› á“á·á„ášá€áƒá¾á‰á”áŸ’ášá—á–á™áŸ‰á¶á„á…áŸ’á”á¶áŸáŸ‹áŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ‡°ğŸ‡­
        </div>
        <h4 class="text-red-500 font-black uppercase mb-3">Khmer Native AI</h4>
        <p class="text-sm text-slate-400 italic">
          á”á€áŸáŸ’ášá¶á™á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášá™áŸ‰á¶á„ášá›á¼á“ á„á¶á™á™á›áŸ‹ á“á·á„á€áŸ†á”áŸ’á›áŸ‚á„áŸ—áŸ”
        </p>
      </div>
    </div>
  </header>

  <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 md:gap-16 items-start">
    <section class="xl:col-span-5 space-y-10">
      <div class="magic-card p-10 md:p-14">
        <h3
          class="text-[11px] font-black text-red-400 uppercase tracking-widest mb-10 flex items-center gap-4"
        >
          <span class="h-1 w-6 bg-red-500 rounded-full"></span> 01. Sync Memory
          Block
        </h3>
        <div
          id="dropZone"
          class="border-2 border-dashed border-white/5 rounded-[40px] p-12 text-center cursor-pointer hover:border-red-500/50 hover:bg-red-500/5 transition-all group"
        >
          <div
            class="text-7xl mb-8 group-hover:scale-110 group-hover:rotate-6 transition-transform"
          >
            ğŸ“„
          </div>
          <p
            class="text-lg md:text-xl text-slate-300 font-bold uppercase tracking-tighter"
          >
            Drop PDF or Click to Scan
          </p>
          <input type="file" id="fileInput" class="hidden" accept=".pdf" />
        </div>

        <div
          id="textPreview"
          class="hidden magic-card p-8 mt-10 bg-emerald-500/5 border-emerald-500/10"
        >
          <div class="flex justify-between items-center mb-6">
            <span
              class="text-[11px] font-black text-emerald-400 uppercase tracking-widest"
              >Neural Data Extracted</span
            >
            <span
              id="pageCount"
              class="text-xs font-mono bg-emerald-500/20 px-3 py-1.5 rounded-full text-white"
              >0 Units Sync</span
            >
          </div>
          <div
            id="previewContent"
            class="text-base text-slate-400 h-40 overflow-y-auto no-scrollbar italic leading-relaxed border-t border-white/5 pt-6"
          ></div>
        </div>
      </div>
    </section>

    <section class="xl:col-span-7 space-y-10">
      <div class="magic-card p-10 md:p-14">
        <h3
          class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-10 flex items-center gap-4"
        >
          <span class="h-1 w-6 bg-slate-500 rounded-full"></span> 02. Neural
          Query Hub
        </h3>
        <div class="flex flex-col md:flex-row gap-5">
          <input
            type="text"
            id="userQuery"
            class="flex-1 bg-black/40 border border-white/5 rounded-3xl px-10 py-7 outline-none focus:border-red-500 transition-all text-xl text-white shadow-inner"
            placeholder="áŸá½ášá˜á€á”áŸ’á¢á¼á“! á…á„áŸ‹áŠá¹á„á¢á¸á€áŸ’á“á»á„ PDF á áŸ’á“á¹á„?"
          />
          <button
            onclick="askKIDA()"
            id="btnAsk"
            class="btn-magic px-14 py-7 rounded-3xl font-black text-sm uppercase tracking-widest active:scale-90"
          >
            EXECUTE
          </button>
        </div>
      </div>

      <div
        id="responseContainer"
        class="hidden animate-in zoom-in-95 duration-700"
      >
        <div
          class="magic-card p-10 md:p-16 border-l-[15px] border-red-500 bg-red-600/5 relative"
        >
          <div
            id="pageBadge"
            class="absolute top-8 right-12 bg-red-500/10 border border-red-500/30 px-6 py-4 rounded-3xl flex items-center gap-4 opacity-0 transition-all duration-1000"
          >
            <div class="flex flex-col text-right">
              <span
                class="text-[9px] font-black text-red-500 uppercase tracking-widest"
                >Source_Location</span
              >
              <span id="pageSource" class="text-xl font-black text-white"
                >N/A</span
              >
            </div>
          </div>
          <div
            class="text-[10px] font-black tracking-[0.5em] text-red-400 opacity-40 uppercase mb-10"
          >
            Extraction_Result_Ready
          </div>
          <div
            id="aiAnswer"
            class="prose-kida text-2xl md:text-3xl font-light text-slate-100 italic"
          ></div>
        </div>
      </div>

      <div
        id="loading"
        class="hidden magic-card p-32 flex flex-col items-center justify-center"
      >
        <div class="relative w-24 h-24 mb-10">
          <div
            class="absolute inset-0 border-8 border-white/5 rounded-full"
          ></div>
          <div
            class="absolute inset-0 border-8 border-t-red-500 rounded-full animate-spin"
          ></div>
        </div>
        <p
          class="text-red-500 font-mono text-sm tracking-[0.6em] uppercase animate-pulse"
        >
          Scanning_Memory_Blocks...
        </p>
      </div>
    </section>
  </div>
</main>

<%- include('partials/footer') %>

<script>
  const socket = io();
  const fileInput = document.getElementById("fileInput");
  let pdfPagesData = [];

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

  // áŸ¡. Interactive Magic Background (Mouse Follow)
  const canvas = document.getElementById("neural-bg");
  const ctx = canvas.getContext("2d");
  let dots = [];
  let mouse = { x: null, y: null };
  window.addEventListener("mousemove", (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
  });

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    dots = [];
    for (let i = 0; i < 70; i++) {
      dots.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        size: Math.random() * 1.5,
      });
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "<%= theme || '#ef4444' %>";
    ctx.strokeStyle = "rgba(239, 68, 68, 0.05)";
    dots.forEach((d) => {
      d.x += d.vx;
      d.y += d.vy;
      if (d.x < 0 || d.x > canvas.width) d.vx *= -1;
      if (d.y < 0 || d.y > canvas.height) d.vy *= -1;

      let dist = Math.hypot(mouse.x - d.x, mouse.y - d.y);
      if (dist < 150) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.stroke();
      }

      ctx.beginPath();
      ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  init();
  draw();

  // áŸ¢. Application Logic
  document.getElementById("dropZone").onclick = () => fileInput.click();
  fileInput.onchange = (e) => handleFile(e.target.files[0]);

  async function handleFile(file) {
    if (!file || file.type !== "application/pdf") {
      return Swal.fire({
        icon: "error",
        title: "Format Error",
        text: "á”á„áŸá»áŸ†ááŸ‚ PDF á‘áŸá”áŸ’á¢á¼á“! ğŸ˜‚",
        background: "#030712",
        color: "#ef4444",
      });
    }
    pdfPagesData = [];
    const reader = new FileReader();
    reader.onload = async function () {
      const typedarray = new Uint8Array(this.result);
      const pdf = await pdfjsLib.getDocument(typedarray).promise;
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        pdfPagesData.push({
          page: i,
          text: content.items.map((s) => s.str).join(" "),
        });
      }
      document.getElementById("previewContent").innerText =
        pdfPagesData[0].text.substring(0, 300) + "...";
      document.getElementById("pageCount").innerText =
        `${pdf.numPages} Units Sync`;
      document.getElementById("textPreview").classList.remove("hidden");
      Swal.fire({
        icon: "success",
        title: "Memory Sync",
        text: "á”á„á¢á¶á“á…á”áŸ‹á á¾á™ áŸá½ášá˜á€á”áŸ’á¢á¼á“!",
        background: "#030712",
        color: "#22c55e",
      });
    };
    reader.readAsArrayBuffer(file);
  }

  function askKIDA() {
    const query = document.getElementById("userQuery").value.trim();
    const firebaseUid = "<%= user ? user.firebaseUid : '' %>";

    if (!query || pdfPagesData.length === 0)
      return Swal.fire({
        icon: "warning",
        title: "Empty Memory",
        text: "á”áŸ„áŸ‡á¯á€áŸá¶ášá±áŸ’á™á”á„á¢á¶á“áŸá·á“! ğŸ˜‚",
        background: "#030712",
        color: "#ef4444",
      });
    if (!firebaseUid)
      return Swal.fire({
        icon: "warning",
        title: "Identity Unknown",
        text: "áŸá¼á˜ Login áŠá¾á˜áŸ’á”á¸ášá€áŸ’áŸá¶á‘á»á€á”áŸ’ášáœááŸ’áá·!",
        background: "#030712",
        color: "#ef4444",
      });

    document.getElementById("loading").classList.remove("hidden");
    document.getElementById("responseContainer").classList.add("hidden");

    socket.emit("ask_kida", {
      userQuery: query,
      pages: pdfPagesData.slice(0, 50),
      firebaseUid: firebaseUid,
    });
  }

  socket.on("kida_result", (data) => {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("responseContainer").classList.remove("hidden");
    document.getElementById("aiAnswer").innerHTML = marked.parse(data.answer);

    const badge = document.getElementById("pageBadge");
    if (data.page_found) {
      document.getElementById("pageSource").innerText =
        "Page " + data.page_found;
      badge.classList.replace("opacity-0", "opacity-100");
    }
    document
      .getElementById("responseContainer")
      .scrollIntoView({ behavior: "smooth" });
  });
</script>
