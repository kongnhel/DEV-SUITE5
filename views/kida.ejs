<%- include('partials/header') %>

<style>
    :root { 
        --primary: <%= theme %>; 
        --bg: #030712; 
    }
    body { background-color: var(--bg); color: #f3f4f6; font-size: 16px; }

    /* Marketing & Visual Style */
    .hero-gradient {
        background: radial-gradient(circle at center, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
    }
    .neural-card {
        background: rgba(15, 23, 42, 0.5);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 40px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .neural-card:hover {
        border-color: rgba(239, 68, 68, 0.2);
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.05);
    }

    .shimmer-text {
        background: linear-gradient(90deg, #fff, var(--primary), #fff);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 4s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .pulse-glow { animation: pulseGlow 2s infinite; }
    @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.1); }
        50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.2); }
    }

    #neural-bg {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -20;
        opacity: 0.15;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<canvas id="neural-bg"></canvas>
<div class="hero-gradient fixed inset-0 -z-10"></div>

<main class="max-w-7xl mx-auto p-4 md:p-12 relative">
    
    <header class="text-center mb-16 space-y-6 animate-in fade-in zoom-in duration-1000">
        <div class="inline-block px-4 py-1 rounded-full bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-black tracking-widest uppercase">
            ğŸš€ Supercharged by Gemini 1.5 Flash
        </div>
        
        <h2 class="text-7xl md:text-9xl font-black tracking-tighter shimmer-text italic uppercase leading-none">
            K-IDA
        </h2>
        
        <div class="max-w-3xl mx-auto space-y-4">
            <p class="text-2xl md:text-4xl font-light text-white leading-tight">
                "á€á»áŸ†á±áŸ’á™á€á¶ášá¢á¶á“ PDF ášá¶á”áŸ‹ášá™á‘áŸ†á–áŸáš á€áŸ’á›á¶á™á‡á¶áŸá»á”á·á“á¢á¶á€áŸ’ášá€áŸ‹ášá”áŸáŸ‹á”á„á¯á„!" 
            </p>
            <p class="text-lg md:text-xl text-slate-400 font-light italic">
                K-IDA á˜á·á“á˜áŸ‚á“á‚áŸ’ášá¶á“áŸ‹ááŸ‚á‡á¶á€á“áŸ’á›áŸ‚á„á‘á»á€á¯á€áŸá¶ášá‘áŸ ááŸ‚á‡á¶ <span class="text-red-500 font-bold">"áá½ášá€áŸ’á”á¶á›á‘á¸áŸ¢"</span> áŠáŸ‚á›á…á¶áŸ†á†áŸ’á›á¾á™ášá¶á›áŸ‹á…á˜áŸ’á„á›áŸ‹á€áŸ’á“á»á„ PDF á”á„á¯á„áŸ” 
                á”áŸ„áŸ‡áœá¶á…á¼á›á˜á€ ášá½á…áŸá½ášá…á„áŸ‹áŠá¹á„á¢á¸á€áŸá”á¶á“ á’á¶á“á¶áá¶á†áŸ’á›á¾á™á›á¿á“á‡á¶á„á”á„á¯á„á‰áŸ‰á¶áŸ†á”á¶á™áŸáŸ’ášá¼á”á‘áŸ€á! ğŸ˜‚
            </p>
        </div>

        <div class="flex flex-wrap justify-center gap-10 pt-8">
            <div class="text-center">
                <p class="text-3xl font-black text-white">100%</p>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Khmer Accuracy</p>
            </div>
            <div class="text-center border-x border-white/10 px-10">
                <p class="text-3xl font-black text-white">Ultra</p>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Fast Ingest</p>
            </div>
            <div class="text-center">
                <p class="text-3xl font-black text-white">Smart</p>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Context Search</p>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 md:gap-12 items-start">
        
        <section class="xl:col-span-5 space-y-8">
            <div class="neural-card p-10 md:p-14 pulse-glow">
                <h3 class="text-[11px] font-black text-red-400 uppercase tracking-widest mb-10 flex items-center gap-4">
                    <span class="h-1 w-6 bg-red-500 rounded-full"></span> 01. Sync Memory Block
                </h3>

                <div id="dropZone" class="border-2 border-dashed border-white/5 rounded-[40px] p-12 md:p-20 text-center cursor-pointer hover:border-red-500/50 hover:bg-red-500/5 transition-all duration-500 group relative">
                    <div class="text-7xl mb-8 group-hover:scale-110 group-hover:rotate-6 transition-transform">ğŸ“„</div>
                    <p class="text-lg md:text-xl text-slate-300 font-bold uppercase tracking-tighter">
                        Drop PDF or Click to Scan
                    </p>
                    <p class="text-xs text-slate-500 mt-2">á”áŸ„áŸ‡á¯á€áŸá¶ášá˜á€ á…á¶áŸ†á”á„á¢á¶á“á±áŸ’á™!</p>
                    <input type="file" id="fileInput" class="hidden" accept=".pdf" />
                </div>

                <div id="textPreview" class="hidden neural-card p-8 mt-10 bg-emerald-500/5 border-emerald-500/10">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[11px] font-black text-emerald-400 uppercase tracking-widest">Neural Data Extracted</span>
                        <span id="pageCount" class="text-xs font-mono bg-emerald-500/20 px-3 py-1.5 rounded-full text-white italic">0 Units Sync</span>
                    </div>
                    <div id="previewContent" class="text-base text-slate-400 h-40 overflow-y-auto no-scrollbar italic leading-relaxed border-t border-white/5 pt-6"></div>
                </div>
            </div>
        </section>

        <section class="xl:col-span-7 space-y-8">
            <div class="neural-card p-10 md:p-14">
                <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-10 flex items-center gap-4">
                    <span class="h-1 w-6 bg-slate-500 rounded-full"></span> 02. Neural Query Hub
                </h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="userQuery" 
                        class="flex-1 bg-black/40 border border-white/5 rounded-3xl px-10 py-7 outline-none focus:border-red-500 transition-all text-xl text-white placeholder:text-slate-700" 
                        placeholder="áŸá½ášá˜á€á”áŸ’á¢á¼á“! á…á„áŸ‹áŠá¹á„á¢á¸á€áŸ’á“á»á„ PDF á áŸ’á“á¹á„?" />
                    <button onclick="askKIDA()" id="btnAsk" 
                        class="bg-red-500 hover:bg-red-400 text-white px-14 py-7 rounded-3xl font-black text-sm uppercase tracking-widest transition-all active:scale-95 shadow-2xl">
                        EXECUTE
                    </button>
                </div>
            </div>

            <div id="responseContainer" class="hidden animate-in slide-in-from-bottom-5 duration-700">
                <div class="neural-card p-10 md:p-16 border-l-[12px] border-red-500 bg-red-600/5 relative overflow-hidden">
                    <div id="pageBadge" class="absolute top-8 right-12 bg-red-500/10 border border-red-500/30 px-6 py-4 rounded-3xl flex items-center gap-4 opacity-0 transition-all duration-1000">
                        <div class="h-4 w-4 rounded-full bg-red-400 animate-pulse"></div>
                        <div class="flex flex-col">
                            <span class="text-[9px] font-black text-red-500 uppercase tracking-widest">Source_Location</span>
                            <span id="pageSource" class="text-xl font-black text-white leading-none">N/A</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-black tracking-[0.5em] text-red-400/40 uppercase mb-10">Intelligence Extraction Result</div>
                    <div id="aiAnswer" class="text-2xl md:text-3xl font-light text-slate-100 italic leading-[1.7] md:pr-24"></div>
                </div>
            </div>

            <div id="loading" class="hidden neural-card p-32 flex flex-col items-center justify-center">
                <div class="w-20 h-20 border-8 border-white/5 border-t-red-500 rounded-full animate-spin"></div>
                <p class="mt-10 text-red-500 font-mono text-xs tracking-[0.5em] uppercase animate-pulse">Scanning_Memory_Blocks...</p>
            </div>
        </section>
    </div>
</main>

<%- include('partials/footer') %>

<script>
    const socket = io();
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    let pdfPagesData = [];

    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    async function handleFile(file) {
        if (!file || file.type !== "application/pdf") {
            return Swal.fire({ icon: "error", title: "Format Error", text: "á”á„áŸá»áŸ†ááŸ‚ File PDF á‘áŸá¢á¶á¢á¼á“! á€á»áŸ†á˜á€á›áŸá„áŸá¾á…! ğŸ˜‚", background: "#030712", color: "#ef4444" });
        }

        pdfPagesData = [];
        const reader = new FileReader();
        reader.onload = async function () {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const text = content.items.map((s) => s.str).join(" ");
                pdfPagesData.push({ page: i, text: text });
            }

            document.getElementById("previewContent").innerText = pdfPagesData.slice(0, 2).map(p => `[UNIT_${p.page}]: ${p.text.substring(0, 150)}...`).join("\n\n");
            document.getElementById("pageCount").innerText = `${pdf.numPages} Units Sync`;
            document.getElementById("textPreview").classList.remove("hidden");

            Swal.fire({ icon: "success", title: "Memory Sync", text: `á”á„á¢á¶á“á…á”áŸ‹á á¾á™! á¯á€áŸá¶ášá‘á¶áŸ†á„ ${pdf.numPages} á‘áŸ†á–áŸáš á“áŸ…á€áŸ’á“á»á„áá½ášá€áŸ’á”á¶á›á”á„á á¾á™!`, background: "#030712", color: "#22c55e" });
        };
        reader.readAsArrayBuffer(file);
    }

    function askKIDA() {
        const query = document.getElementById("userQuery").value.trim();
        if (!query || pdfPagesData.length === 0) {
            return Swal.fire({ icon: "warning", title: "Missing Data", text: "á”áŸ„áŸ‡á¯á€áŸá¶ášá±áŸ’á™á”á„áŸá·á“ ášá½á…á…á¶áŸ†áŸá½áš! á€á»áŸ†á…á„áŸ‹á‰áŸ‰á¶áŸ†á”á¶á™á˜á·á“áŠá¶áŸ†! ğŸ˜‚", background: "#030712", color: "#ef4444" });
        }

        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("responseContainer").classList.add("hidden");
        socket.emit("ask_kida", { userQuery: query, pages: pdfPagesData.slice(0, 50) });
    }

    socket.on("kida_result", (data) => {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("responseContainer").classList.remove("hidden");
        typeWriter("aiAnswer", data.answer);

        const badge = document.getElementById("pageBadge");
        if (data.page_found) {
            document.getElementById("pageSource").innerText = data.page_found;
            badge.classList.replace("opacity-0", "opacity-100");
        }
    });

    function typeWriter(id, text) {
        let i = 0; const el = document.getElementById(id); el.innerHTML = "";
        function type() { if (i < text.length) { el.innerHTML += text.charAt(i); i++; setTimeout(type, 15); } }
        type();
    }

    const canvas = document.getElementById("neural-bg");
    const ctx = canvas.getContext("2d");
    let dots = [];
    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        dots = [];
        for (let i = 0; i < 40; i++) dots.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2 });
    }
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "<%= theme %>";
        dots.forEach((d) => {
            d.x += d.vx; d.y += d.vy;
            if (d.x < 0 || d.x > canvas.width) d.vx *= -1; if (d.y < 0 || d.y > canvas.height) d.vy *= -1;
            ctx.beginPath(); ctx.arc(d.x, d.y, 1.2, 0, Math.PI * 2); ctx.fill();
        });
        requestAnimationFrame(draw);
    }
    window.addEventListener("resize", init); init(); draw();
</script>