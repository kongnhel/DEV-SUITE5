<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    --primary: <%= theme || "#6366f1" %>;
    --secondary: #a855f7;
    --bg: #030712;
    --magic-glow: rgba(99, 102, 241, 0.3);
  }
  body {
    font-family: "Kantumruy Pro", sans-serif;
    background-color: var(--bg);
    color: #e2e8f0;
    overflow-x: hidden;
  }

  /* áŸ¡. Interactive Magic Background */
  #neural-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -20;
    opacity: 0.25;
  }
  .study-gradient {
    background: radial-gradient(
      circle at 50% 50%,
      rgba(99, 102, 241, 0.1) 0%,
      transparent 80%
    );
  }

  /* áŸ¢. Magic Border Animation (á€á¼áŠá˜á€á–á¸á¢á“á¶á‚á) */
  .magic-card {
    position: relative;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(30px);
    border-radius: 40px;
    z-index: 1;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.4s ease;
  }
  .magic-card::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      transparent,
      var(--primary),
      transparent 30%
    );
    animation: rotateMagic 6s linear infinite;
    z-index: -1;
    opacity: 0.2;
  }
  @keyframes rotateMagic {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* áŸ£. Shimmer & Glow Effects */
  .shimmer-text {
    background: linear-gradient(
      90deg,
      #fff,
      var(--primary),
      var(--secondary),
      #fff
    );
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 5s linear infinite;
  }
  @keyframes shine {
    to {
      background-position: 200% center;
    }
  }

  /* áŸ¤. Hover & Floating Animation */
  .float-ui {
    animation: float 4s ease-in-out infinite;
  }
  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-15px);
    }
  }

  .status-badge {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    color: var(--primary);
    padding: 6px 16px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 800;
    text-shadow: 0 0 10px var(--magic-glow);
  }

  .btn-magic {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff;
    font-weight: 900;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 20px var(--magic-glow);
  }
  .btn-magic:hover {
    transform: scale(1.05);
    box-shadow: 0 0 40px var(--primary);
  }

  /* Responsive Input Fix */
  .big-input {
    background: rgba(0, 0, 0, 0.4) !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    transition: all 0.4s ease;
    font-size: 1.1rem;
    line-height: 1.8;
  }
  .big-input:focus {
    border-color: var(--primary) !important;
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
  }
</style>

<canvas id="neural-bg"></canvas>
<div class="study-gradient fixed inset-0 -z-10"></div>

<main class="max-w-7xl mx-auto p-4 md:p-12 relative">
  <header
    class="text-center mb-20 space-y-10 animate-in fade-in slide-in-from-top-10 duration-1000"
  >
    <div
      class="inline-flex items-center gap-3 px-6 py-2 rounded-full bg-indigo-500/10 border border-indigo-500/20 float-ui"
    >
      <span class="w-2 h-2 rounded-full bg-indigo-400 animate-ping"></span>
      <span class="text-indigo-400 text-xs font-black tracking-widest uppercase"
        >ğŸ§  Neural Study Assist V4.0</span
      >
    </div>

    <h2
      class="text-6xl md:text-9xl font-black tracking-tighter shimmer-text italic uppercase leading-none"
    >
      STUDY BUDDY
    </h2>

    <div class="max-w-4xl mx-auto space-y-8">
      <p class="text-3xl md:text-5xl font-light text-white leading-tight">
        "ášáŸ€á“á±áŸ’á™á†áŸ’á›á¶á á˜á·á“á˜áŸ‚á“ášáŸ€á“á±áŸ’á™á ááŸ‹! á±áŸ’á™á”á„ AI á€áŸ’á›á¶á™á‡á¶
        <span class="text-indigo-400 font-bold">á˜á“áŸ’áá¢á¶á‚á˜</span>
        á“áŸƒá…áŸ†ááŸáŸ‡áŠá¹á„á”áŸ’á¢á¼á“!"
      </p>
      <p
        class="text-lg md:text-xl text-slate-400 font-light italic leading-relaxed px-4"
      >
        á”áŸ’á¢á¼á“á’á»á‰á“á¹á„á€á¶ášá¢á¶á“á˜áŸášáŸ€á“á€áŸ’ášá¶áŸáŸ‹áŸ—á˜áŸ‚á“á‘áŸ?
        <strong class="text-indigo-400">Study Buddy</strong>
        á“á¹á„á‡á½á™á”áŸ’á¢á¼á“áŸá„áŸ’ááŸá”á…áŸ†áá»á…áŸáŸ†áá¶á“áŸ‹áŸ— á“á·á„á”á„áŸ’á€á¾á Quiz
        áŠá¾á˜áŸ’á”á¸ááŸáŸáŸ’ááá½ášá€áŸ’á”á¶á›á”áŸ’á¢á¼á“á—áŸ’á›á¶á˜áŸ—áŸ” á˜á·á“áá¶á‡á¶á˜áŸášáŸ€á“áœá·á‘áŸ’á™á¶áŸá¶áŸáŸ’ááŸ’áš
        á¬á”áŸ’ášáœááŸ’áá·áŸá¶áŸáŸ’ááŸ’áš á”áŸ„áŸ‡áœá¶á…á¼á›á˜á€ á…á¶áŸ†á”á„á‡á½á™áŸá˜áŸ’ášá½á›á±áŸ’á™ "á—áŸ’á›áºá—áŸ’á“áŸ‚á€" á áŸ’á˜á„! ğŸ˜‚
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-10">
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ“œ
        </div>
        <h4 class="text-indigo-400 font-black uppercase mb-3">
          Instant Summary
        </h4>
        <p class="text-sm text-slate-400 italic">
          á”áŸ†á”áŸ’á›áŸ‚á„á˜áŸášáŸ€á“ášá¶á”áŸ‹áŸá·á”á‘áŸ†á–áŸáš á±áŸ’á™á˜á€á“áŸ…ááŸ’ášá¹á˜á…áŸ†áá»á…ááŸ’á›á¹á˜áŸ—á”áŸ†á•á»ááŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ§©
        </div>
        <h4 class="text-indigo-400 font-black uppercase mb-3">
          Interactive Quiz
        </h4>
        <p class="text-sm text-slate-400 italic">
          ááŸáŸáŸ’ááŸá˜ááŸ’áá—á¶á–á”áŸ’á¢á¼á“á—áŸ’á›á¶á˜áŸ— á‡á¶á˜á½á™áŸáŸ†áá½ášáŠáŸ‚á›á”á„áŸ’á€á¾ááŠáŸ„á™ AIáŸ”
        </p>
      </div>
      <div class="magic-card p-10 text-center group">
        <div class="text-5xl mb-6 group-hover:scale-125 transition-transform">
          ğŸ”¥
        </div>
        <h4 class="text-indigo-400 font-black uppercase mb-3">
          Daily Motivation
        </h4>
        <p class="text-sm text-slate-400 italic">
          á–á¶á€áŸ’á™á›á¾á€á‘á¹á€á…á·ááŸ’áá€áŸ†á”áŸ’á›áŸ‚á„áŸ— áŠá¾á˜áŸ’á”á¸á±áŸ’á™á”áŸ’á¢á¼á“á˜á¶á“á€á˜áŸ’á›á¶áŸ†á„ášáŸ€á“á”á“áŸ’ááŸ”
        </p>
      </div>
    </div>
  </header>

  <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 md:gap-16 items-start">
    <div class="xl:col-span-5 space-y-10">
      <div class="magic-card p-10 md:p-14 shadow-2xl">
        <div class="flex items-center gap-4 mb-10">
          <div class="p-3 bg-indigo-500/10 rounded-2xl">
            <span class="text-3xl">ğŸ“¥</span>
          </div>
          <div>
            <h3
              class="text-lg font-black text-white uppercase tracking-tighter"
            >
              Knowledge Input
            </h3>
            <p class="text-xs text-slate-500">á”á‰áŸ’á…á¼á›ááŸ’á›á¹á˜áŸá¶ášá˜áŸášáŸ€á“áá¶á„á€áŸ’ášáŸ„á˜</p>
          </div>
        </div>

        <textarea
          id="studyContent"
          class="w-full big-input rounded-[30px] p-8 h-80 md:h-[500px] outline-none text-slate-200 resize-none placeholder:text-slate-800 shadow-inner"
          placeholder="á”á·á‘á—áŸ’á‡á¶á”áŸ‹á¢ááŸ’áá”á‘á˜áŸášáŸ€á“áŠáŸ‚á›á”áŸ’á¢á¼á“á…á„áŸ‹á±áŸ’á™á”á„áŸá„áŸ’ááŸá”á±áŸ’á™... (á§á‘á¶á ášááŸáŸ– á…áŸ’á”á¶á”áŸ‹á‰á¼áá»á“)"
        ></textarea>

        <button
          onclick="processStudy()"
          id="btnAction"
          class="btn-magic w-full mt-10 py-7 rounded-[35px] text-xl uppercase tracking-[0.3em] flex justify-center items-center gap-5 active:scale-90"
        >
          <span>Activate Mission</span>
        </button>
      </div>
    </div>

    <div class="xl:col-span-7">
      <div
        id="loading"
        class="hidden magic-card p-32 flex flex-col items-center justify-center"
      >
        <div class="relative w-24 h-24 mb-10">
          <div
            class="absolute inset-0 border-8 border-white/5 rounded-full"
          ></div>
          <div
            class="absolute inset-0 border-8 border-t-indigo-500 rounded-full animate-spin"
          ></div>
        </div>
        <p
          class="text-indigo-400 font-mono text-sm tracking-[0.6em] animate-pulse uppercase"
        >
          Synthesizing_Knowledge...
        </p>
      </div>

      <div
        id="resultArea"
        class="hidden space-y-10 animate-in zoom-in-95 duration-700"
      >
        <div
          class="magic-card p-10 md:p-16 border-l-[15px] border-indigo-500 bg-indigo-500/5"
        >
          <h4
            class="text-indigo-400 font-black uppercase tracking-[0.4em] text-[10px] mb-8 flex items-center gap-3"
          >
            <span class="h-1 w-10 bg-indigo-500 rounded-full"></span>
            áŸáŸá…á€áŸ’áŠá¸áŸá„áŸ’ááŸá”á˜áŸášáŸ€á“ (Summary)
          </h4>
          <div
            id="summaryText"
            class="text-2xl md:text-3xl font-light text-slate-100 leading-relaxed italic"
          ></div>
        </div>

        <div class="magic-card p-10 md:p-16 border-t border-white/5">
          <h4
            class="text-yellow-500 font-black uppercase tracking-[0.4em] text-[10px] mb-10 flex items-center gap-3"
          >
            <span class="h-1 w-10 bg-yellow-500 rounded-full"></span> Brain Test
            (Active Recall)
          </h4>
          <div id="quizContainer" class="space-y-8"></div>
        </div>

        <div
          class="magic-card p-10 bg-indigo-500/5 text-center relative overflow-hidden"
        >
          <div
            class="absolute -top-10 -left-10 text-8xl opacity-10 uppercase font-black"
          >
            Boost
          </div>
          <p
            id="motivationText"
            class="text-xl md:text-3xl text-indigo-300 font-medium italic relative z-10"
          ></p>
        </div>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>

<script>
  const socket = io();

  // áŸ¡. Interactive Magic Background (Mouse Follow)
  const canvas = document.getElementById("neural-bg");
  const ctx = canvas.getContext("2d");
  let dots = [];
  let mouse = { x: null, y: null };
  window.addEventListener("mousemove", (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
  });

  function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    dots = [];
    for (let i = 0; i < 70; i++) {
      dots.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        size: Math.random() * 1.5,
      });
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "<%= theme || '#6366f1' %>";
    ctx.strokeStyle = "rgba(99, 102, 241, 0.05)";
    dots.forEach((d) => {
      d.x += d.vx;
      d.y += d.vy;
      if (d.x < 0 || d.x > canvas.width) d.vx *= -1;
      if (d.y < 0 || d.y > canvas.height) d.vy *= -1;

      let dist = Math.hypot(mouse.x - d.x, mouse.y - d.y);
      if (dist < 150) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.stroke();
      }

      ctx.beginPath();
      ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  init();
  draw();

  // áŸ¢. AI Study Logic
  function processStudy() {
    const content = document.getElementById("studyContent").value.trim();
    const firebaseUid = "<%= user ? user.firebaseUid : '' %>";

    if (!content)
      return Swal.fire({
        icon: "info",
        title: "Empty Brain",
        text: "áŠá¶á€áŸ‹á˜áŸášáŸ€á“á±áŸ’á™á”á„á˜á¾á›áŸá·á“á”áŸ’á¢á¼á“ á€á»áŸ†á…á„áŸ‹ášáŸ€á“á€á¶ááŸ‹! ğŸ˜‚",
        background: "#030712",
        color: "#818cf8",
      });
    if (!firebaseUid)
      return Swal.fire({
        icon: "warning",
        title: "Identity Unknown",
        text: "áŸá¼á˜ Login áŸá·á“ áŠá¾á˜áŸ’á”á¸á±áŸ’á™á”á„ášá€áŸ’áŸá¶á‘á»á€áŠá¶á“á‡á¾á„á˜áŸášáŸ€á“á”áŸ’á¢á¼á“!",
        background: "#030712",
        color: "#818cf8",
      });

    document.getElementById("loading").classList.remove("hidden");
    document.getElementById("resultArea").classList.add("hidden");
    document.getElementById("btnAction").disabled = true;

    socket.emit("study_assist", { content: content, firebaseUid: firebaseUid });
  }

  socket.on("study_result", (res) => {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("resultArea").classList.remove("hidden");
    document.getElementById("btnAction").disabled = false;

    typeWriter("summaryText", res.summary);
    document.getElementById("motivationText").innerText =
      "â€œ " + res.funny_motivation + " â€";

    const container = document.getElementById("quizContainer");
    container.innerHTML = "";
    // á”á„áŸ’á á¶á‰ Quiz á”áŸ‚á” Interactive
    res.quiz.forEach((q, idx) => {
      const card = document.createElement("div");
      card.className =
        "magic-card p-10 bg-white/5 border border-white/5 mb-8 hover:border-indigo-500/40 transition-all";
      card.innerHTML = `
        <p class="font-black text-white mb-8 text-2xl italic"><span class="text-indigo-500 mr-3">Q${idx + 1}:</span> ${q.question}</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${q.options
            .map(
              (opt) => `
            <button onclick="checkAnswer(this, '${opt}', '${q.answer}')" class="text-left p-6 rounded-2xl bg-black/40 border border-white/5 hover:bg-indigo-600 hover:text-white transition-all text-lg font-medium shadow-lg">
              ${opt}
            </button>
          `,
            )
            .join("")}
        </div>
      `;
      container.appendChild(card);
    });
    document
      .getElementById("resultArea")
      .scrollIntoView({ behavior: "smooth" });
  });

  function checkAnswer(btn, selected, correct) {
    if (selected === correct) {
      btn.classList.add(
        "bg-emerald-500",
        "text-black",
        "border-emerald-400",
        "shadow-[0_0_20px_rgba(16,185,129,0.4)]",
      );
      btn.innerHTML += " âœ¨ (Correct!)";
    } else {
      btn.classList.add(
        "bg-red-500",
        "text-white",
        "border-red-400",
        "shadow-[0_0_20px_rgba(239,68,68,0.4)]",
      );
      btn.innerHTML += " ğŸ’€ (Oops!)";
    }
    const parent = btn.parentElement;
    parent.querySelectorAll("button").forEach((b) => (b.disabled = true));
  }

  function typeWriter(id, text) {
    let i = 0;
    const el = document.getElementById(id);
    el.innerHTML = "";
    function type() {
      if (i < text.length) {
        el.innerHTML += text.charAt(i);
        i++;
        setTimeout(type, 15);
      }
    }
    type();
  }

  window.addEventListener("resize", init);
</script>
